!function(t,e,i){var n=(i.un,i.uns,i["static"]),r=i["class"],a=i.getset,s=(i.__newvec,laya.ani.AnimationPlayer),o=(laya.ani.AnimationState,laya.webgl.atlas.AtlasResourceManager,laya.webgl.utils.Buffer),l=laya.utils.Byte,h=laya.utils.ClassUtils,u=laya.particle.emitter.EmitterBase,_=(laya.events.Event,laya.events.EventDispatcher),c=laya.utils.Handler,d=laya.webgl.utils.IndexBuffer2D,f=laya.ani.KeyframesAniTemplet,m=laya.net.Loader,p=laya.display.Node,v=(laya.particle.ParticleSettings,laya.particle.shader.ParticleShader),g=laya.particle.ParticleTemplateWebGL,T=laya.renders.Render,x=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),I=laya.resource.Resource,M=laya.utils.RunDriver,C=laya.webgl.shader.Shader,D=laya.webgl.shader.ShaderDefines,E=laya.display.Sprite,A=laya.utils.Stat,y=laya.resource.Texture,V=laya.net.URL,b=laya.webgl.utils.ValusArray,P=laya.webgl.utils.VertexBuffer2D,w=laya.webgl.WebGL,L=laya.webgl.WebGLContext,S=(laya.webgl.resource.WebGLImage,laya.webgl.resource.WebGLImageCube),R=laya.webgl.resource.WebGLRenderTarget;i["interface"]("laya.d3.core.render.IRender"),i["interface"]("laya.d3.graphics.IVertex"),i["interface"]("laya.d3.core.render.IUpdate");var O=function(){function t(t){this._templet=null,this._bakedVertexes=null,this._bakedIndices=null,this._isVertexbaked=!1,this._indexOfHost=0,this.mesh=null,this._templet=t}r(t,"laya.d3.core.fileModel.SubMesh");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRender":!0}),e.getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._templet.getVB():null},e.getIndexBuffer=function(){return this._templet.getIB()},e.getBakedVertexs=function(t){if(void 0===t&&(t=0),0===t){if(this._bakedVertexes)return this._bakedVertexes;var e=4,i=this._templet.getVB();this._bakedVertexes=i.getFloat32Array().slice();for(var n=i.vertexDeclaration,r=n.shaderAttribute.POSITION[4]/e,a=n.shaderAttribute.NORMAL[4]/e,s=this.mesh.transform.worldMatrix,o=0;o<this._bakedVertexes.length;o+=n.vertexStride/e){var l=o+r;Dt.transformVector3ArrayToVector3ArrayCoordinate(this._bakedVertexes,l,s,this._bakedVertexes,l),Dt.transformVector3ArrayToVector3ArrayCoordinate(this._bakedVertexes,a,s,this._bakedVertexes,a)}return this._isVertexbaked=!0,this._bakedVertexes}return null},e.getBakedIndices=function(){return this._bakedIndices?this._bakedIndices:this._bakedIndices=this._templet.getIB().getUint16Array()},e._getShader=function(t,e,i){if(!i)return null;var n=0,r=e.vertexDeclaration.shaderAttribute;r.UV&&(n|=i.shaderDef),r.COLOR&&(n|=32),t.scene.enableFog&&(n|=131072),n>0&&t.shaderDefs.addInt(n);var a=i.getShader(t);return a},e._render=function(t){var e=this._templet,i=this._templet._meshTemplet,n=e.getVB(),r=e.getIB(),a=e.getMaterial(t.owner.materials||i.materials);if(a.normalTexture&&!n.vertexDeclaration.shaderAttribute.TANGENT0){var s=n.getFloat32Array(),o=Dt.GenerateTangent(s,n.vertexDeclaration.vertexStride/4,n.vertexDeclaration.shaderAttribute.POSITION[4]/4,n.vertexDeclaration.shaderAttribute.UV[4]/4,r.getUint16Array()),l=Dt.getVertexTangentDeclaration(n.vertexDeclaration.getVertexElements()),h=Ft.create(l,35044);h.append(o),e.getVB().dispose(),e.setVB(h),this.templet._bufferUsage.TANGENT0=h}if(null===r)return!1;if(n?n.bind_upload(r):i.vb.bind_upload(r),a){var u=this._getShader(t,n,a),_=t.shaderValue.length;t.shaderValue.pushArray(n.vertexDeclaration.shaderValues);var c=t.owner,d=c.transform.getWorldMatrix(-2),f=t.renderObj.tag.worldTransformModifyID;if(t.shaderValue.pushValue("MATRIX1",d.elements,f),ft.multiply(t.projectionViewMatrix,d,t.owner.wvpMatrix),t.shaderValue.pushValue("MVPMATRIX",c.wvpMatrix.elements,t.camera.transform._worldTransformModifyID+f+t.camera._projectionMatrixModifyID),!a.upload(t,e._finalBufferUsageDic,u))return t.shaderValue.length=_,!1;t.shaderValue.length=_}return t.context.drawElements(4,e._elementCount,5123,0),A.drawCall++,A.trianglesFaces+=e._elementCount/3,!0},a(0,e,"VertexBufferCount",function(){return 1}),a(0,e,"indexOfHost",function(){return this._indexOfHost}),a(0,e,"templet",function(){return this._templet}),t}(),N=(function(){function t(){this.texturePath=null,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this.maxSegments=200,this.color=new Tt(1,1,1,1)}return r(t,"laya.d3.core.glitter.GlitterSettings"),t}(),function(){function t(){this._tempVector30=new gt,this._tempVector31=new gt,this._tempVector32=new gt,this._a=new gt,this._b=new gt,this._c=new gt,this._d=new gt}r(t,"laya.d3.core.glitter.SplineCurvePositionVelocity");var e=t.prototype;return e.Init=function(t,e,i,n){t.cloneTo(this._d),e.cloneTo(this._c),gt.scale(t,2,this._a),gt.scale(i,2,this._tempVector30),gt.subtract(this._a,this._tempVector30,this._a),gt.add(this._a,e,this._a),gt.add(this._a,n,this._a),gt.scale(i,3,this._b),gt.scale(t,3,this._tempVector30),gt.subtract(this._b,this._tempVector30,this._b),gt.subtract(this._b,n,this._b),gt.scale(e,2,this._tempVector30),gt.subtract(this._b,this._tempVector30,this._b)},e.Slerp=function(t,e){gt.scale(this._a,t*t*t,this._tempVector30),gt.scale(this._b,t*t,this._tempVector31),gt.scale(this._c,t,this._tempVector32),gt.add(this._tempVector30,this._tempVector31,e),gt.add(e,this._tempVector32,e),gt.add(e,this._d,e)},t}()),U=function(){function t(){if(this._id=0,this._number=0,this._mask=0,this._active=!0,this._visible=!0,this.name=null,this._id=t._uniqueIDCounter,t._uniqueIDCounter++,this._id>32)throw new Error("不允许创建Layer，请参考函数getLayerByNumber、getLayerByMask、getLayerByName！")}r(t,"laya.d3.core.Layer");var e=t.prototype;return a(0,e,"number",function(){return this._number}),a(0,e,"mask",function(){return this._mask}),a(0,e,"active",function(){return this._active},function(e){29!==this._number&&30!=this._number&&(this._active=e,e?t._activeLayers=t._activeLayers|this.mask:t._activeLayers=t._activeLayers&~this.mask)}),a(0,e,"visible",function(){return this._visible},function(e){29!==this._number&&30!=this._number&&(this._visible=e,e?t._visibleLayers=t._visibleLayers|this.mask:t._visibleLayers=t._visibleLayers&~this.mask)}),a(1,t,"activeLayers",function(){return t._activeLayers},function(e){t._activeLayers=e|t.getLayerByNumber(29).mask|t.getLayerByNumber(30).mask;for(var i=0;i<t._layerList.length;i++){var n=t._layerList[i];n._active=0!==(n._mask&t._activeLayers)}}),a(1,t,"visibleLayers",function(){return t._visibleLayers},function(e){t._visibleLayers=e|t.getLayerByNumber(29).mask|t.getLayerByNumber(30).mask;for(var i=0;i<t._layerList.length;i++){var n=t._layerList[i];n._visible=0!==(n._mask&t._visibleLayers)}}),t.__init__=function(){t._layerList.length=31;for(var e=0;31>e;e++){var i=new t;t._layerList[e]=i,0===e?i.name="Default Layer":29===e?i.name="Reserved Layer0":30===e?i.name="Reserved Layer1":i.name="Layer-"+e,i._number=e,i._mask=Math.pow(2,e)}t._activeLayers=2147483647,t._visibleLayers=2147483647,t._currentCameraCullingMask=2147483647,t.currentCreationLayer=t._layerList[0]},t.getLayerByNumber=function(e){if(0>e||e>30)throw new Error("无法返回指定Layer，该number超出范围！");return t._layerList[e]},t.getLayerByMask=function(e){for(var i=0;31>i;i++)if(t._layerList[i].mask===e)return t._layerList[i];throw new Error("无法返回指定Layer,该mask不存在")},t.getLayerByName=function(e){for(var i=0;31>i;i++)if(t._layerList[i].name===e)return t._layerList[i];throw new Error("无法返回指定Layer,该name不存在")},t.isActive=function(e){return 0!=(e&t._activeLayers)},t.isVisible=function(e){return 0!=(e&t._currentCameraCullingMask&t._visibleLayers)},t._uniqueIDCounter=1,t._layerCount=31,t._layerList=[],t._activeLayers=0,t._visibleLayers=0,t._currentCameraCullingMask=0,t.currentCreationLayer=null,t}(),F=(function(){function t(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._renderState=null,this._sharderNameID=0,this._shader=null,this._posShaderValue=[3,5126,!1,28,0],this._colorShaderValue=[4,5126,!1,28,12],this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._wvpMatrix=new ft,this._vb=new P(-1,35048),this._ib=new d,this._sharderNameID=C.nameKey.get("SIMPLE")}r(t,"laya.d3.core.PhasorSpriter3D");var e=t.prototype;return e.line=function(t,e,i,n,r,a,s,o,l,h,u,_,c,d){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t,e,i,n,r,a,s),this.addVertex(o,l,h,u,_,c,d),this.addIndexes(this._tempUint0,this._tempUint0+1),this},e.circle=function(t,e,i,n,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*e,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/e,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*t,Math.cos(this._tempNumver0)*t,0,i,n,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},e.plane=function(t,e,i,n,r,a,s,o,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i,a,s,o,l),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i,a,s,o,l),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i,a,s,o,l),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i,a,s,o,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},e.box=function(t,e,i,n,r,a,s,o,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},e.cone=function(t,e,i,n,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*i+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*i>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/i,this.addVertexIndex(0,e,0,n,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,n,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<i;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==i-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+(this._tempInt0+i)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==i-1?this.addIndexes(this._tempUint1+i+2):this.addIndexes(this._tempUint1+this._tempInt0+i+1),this.addIndexes(this._tempUint1+this._tempInt0+i),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},e.boudningBoxLine=function(t,e,i,n,r,a,s,o,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t,r,a,s,o,l,h),this.addVertex(n,r,a,s,o,l,h),this.addVertex(t,e,a,s,o,l,h),this.addVertex(n,e,a,s,o,l,h),this.addVertex(n,r,i,s,o,l,h),this.addVertex(t,r,i,s,o,l,h),this.addVertex(n,e,i,s,o,l,h),this.addVertex(t,e,i,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},e.addVertex=function(t,e,i,n,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=t,this._vbData[this._posInVBData+1]=e,this._vbData[this._posInVBData+2]=i,this._vbData[this._posInVBData+3]=n,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},e.addVertexIndex=function(t,e,i,n,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=t,this._vbData[o+1]=e,this._vbData[o+2]=i,this._vbData[o+3]=n,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},e.addIndexes=function(t){var e=arguments;this._hasBegun||this.addVertexIndexException();for(var i=0;i<e.length;i++)this._ibData[this._posInIBData]=e[i],this._posInIBData++;return this},e.begin=function(t,e,i){return this._hasBegun&&this.beginException0(),1!==t&&4!==t&&this.beginException1(),this._primitiveType=t,this._wvpMatrix=e,this._renderState=i,this._hasBegun=!0,this},e.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},e.flush=function(){if(0!==this._posInVBData){this._ib.clear(),this._ib.append(this._ibData),this._vb.clear(),this._vb.append(this._vbData),this._vb.bind_upload(this._ib);var t=this._renderState.shaderValue.length,e=this._renderState.shaderDefs.getValue();this._shader=this.getShader(this._renderState),this._renderState.shaderValue.pushValue(laya.webgl.utils.VertexElementUsage.POSITION0,this._posShaderValue,-1),this._renderState.shaderValue.pushValue(laya.webgl.utils.VertexElementUsage.COLOR0,this._colorShaderValue,-1),this._renderState.shaderValue.pushValue("MVPMATRIX",this._wvpMatrix.elements,-1),this._renderState.shaderValue.pushValue("LUMINANCE",1,-1),this._shader.uploadArray(this._renderState.shaderValue.data,this._renderState.shaderValue.length,null),this._renderState.shaderDefs.setValue(e),this._renderState.shaderValue.length=t,A.drawCall++,w.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0}},e.getShader=function(t){var e=t.shaderDefs._value;t.shaderDefs._value=-449&e,t.shaderDefs.add(32);var i=t.shaderDefs.getValue()|t.shadingMode+2e-4*this._sharderNameID,n=this._shader?this._shader:C.getShader(i);return n||(n=C.withCompile(this._sharderNameID,t.shadingMode,t.shaderDefs.toNameDic(),i,null))},e.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},e.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},e.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},e.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},e.drawLinesException=function(){throw new Error("您必须确保在此之前已调用bengin()且使用“LINES”基元！")},e.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用bengin()且使用“TRIANGLES”基元！")},t}(),function(){function t(){}r(t,"laya.d3.core.render.RenderClip");var e=t.prototype;return e.view=function(t){return!0},t}()),B=function(){function t(){this.depthTest=!0,this.depthMask=1,this.blend=!1,this.cullFace=!0,this.sFactor=1,this.dFactor=0,this.frontFace=2304}return r(t,"laya.d3.core.render.RenderConfig"),t}(),G=function(){function t(){this.type=0,this.owner=null,this.renderElement=null,this.material=null,this.tag=null,this.sortID=0}return r(t,"laya.d3.core.render.RenderObject"),t}(),H=function(){function t(t){this._renderObjects=null,this._length=0,this._staticRenderObjects=null,this._staticLength=0,this._merageRenderObjects=null,this._merageLength=0,this._renderConfig=null,this._staticBatchManager=null,this._renderConfig=t,this._renderObjects=[],this._length=0,this._staticRenderObjects=[],this._staticLength=0,this._merageRenderObjects=[],this._merageLength=0,this._staticBatchManager=new z}r(t,"laya.d3.core.render.RenderQuene");var e=t.prototype;return e._preRenderUpdateComponents=function(t,e){for(var i=0;i<t.componentsCount;i++){var n=t.getComponentByIndex(i);!n.started&&(n._start(e),n.started=!0),n.isActive&&n._preRenderUpdate(e)}},e._postRenderUpdateComponents=function(t,e){for(var i=0;i<t.componentsCount;i++){var n=t.getComponentByIndex(i);!n.started&&(n._start(e),n.started=!0),n.isActive&&n._postRenderUpdate(e)}},e._setState=function(t){L.setDepthTest(t,this._renderConfig.depthTest),L.setDepthMask(t,this._renderConfig.depthMask),L.setBlend(t,this._renderConfig.blend),L.setBlendFunc(t,this._renderConfig.sFactor,this._renderConfig.dFactor),L.setCullFace(t,this._renderConfig.cullFace),L.setFrontFaceCCW(t,this._renderConfig.frontFace)},e._render=function(e){this._renderObjects.length=this._length,this._renderObjects.sort(t._sort);for(var i,n,r,a=!1,s=!1,o=0,l=0,h=this._length;h>l;l++){var u=this._renderObjects[l],_=u.renderElement,c=u.owner.isStatic,d=_.getVertexBuffer(0);if(i===u.material&&n===d.vertexDeclaration&&a&&c&&1===_.VertexBufferCount&&u.owner.visible){if(s){if(!r.addRenderObj(_)){s=!1,a=c,i=u.material,n=d.vertexDeclaration,this._merageRenderObjects[this._merageLength++]=this._renderObjects[o++];continue}o++}else{r=this._staticBatchManager.getStaticBatchQneue(n,i);var f=this._renderObjects[l-1];if(!r.addRenderObj(f.renderElement)||!r.addRenderObj(_)){s=!1,a=c,i=u.material,n=d.vertexDeclaration,this._merageRenderObjects[this._merageLength++]=this._renderObjects[o++];continue}var m=this._getStaticRenderObj();m.renderElement=r,m.type=1,this._merageRenderObjects[this._merageLength-1]=m,o++}s=!0}else this._merageRenderObjects[this._merageLength++]=this._renderObjects[o++],s=!1;a=c,i=u.material,n=d.vertexDeclaration}this._staticBatchManager.garbageCollection(),this._staticBatchManager._finsh();var p,v=e.shaderValue.length;for(l=0,h=this._merageLength;h>l;l++){p=this._merageRenderObjects[l];var g=0;if(0===p.type){var T=p.owner;e.owner=T,e.renderObj=p,g=e.shaderDefs.getValue(),this._preRenderUpdateComponents(T,e),T.visible&&p.renderElement._render(e),this._postRenderUpdateComponents(T,e),e.shaderDefs.setValue(g)}else 1===p.type&&(e.owner=null,e.renderObj=p,g=e.shaderDefs.getValue(),p.renderElement._render(e),e.shaderDefs.setValue(g));e.shaderValue.length=v}},e.get=function(){var t=this._renderObjects[this._length++];return t||(this._renderObjects[this._length-1]=new G)},e._getStaticRenderObj=function(){var t=this._staticRenderObjects[this._staticLength++];return t||(this._staticRenderObjects[this._staticLength-1]=new G)},e.reset=function(){this._length=0,this._staticLength=0,this._merageLength=0},a(0,e,"length",function(){return this._length}),t._sort=function(t,e){if(t.owner.isStatic&&e.owner.isStatic){var i=t.renderElement.getVertexBuffer().vertexDeclaration.id,n=e.renderElement.getVertexBuffer().vertexDeclaration.id,r=i-n;if(0!==r)return r;if(t.material&&e.material){var a=t.material.id-e.material.id;if(0!==a)return a}}return t.sortID-e.sortID},t.NONEWRITEDEPTH=0,t.OPAQUE=1,t.OPAQUE_DOUBLEFACE=2,t.ALPHA_BLEND=3,t.ALPHA_BLEND_DOUBLEFACE=4,t.ALPHA_ADDTIVE_BLEND=5,t.ALPHA_ADDTIVE_BLEND_DOUBLEFACE=6,t.DEPTHREAD_ALPHA_BLEND=7,t.DEPTHREAD_ALPHA_BLEND_DOUBLEFACE=8,t.DEPTHREAD_ALPHA_ADDTIVE_BLEND=9,t.DEPTHREAD_ALPHA_ADDTIVE_BLEND_DOUBLEFACE=10,t}(),k=function(){function t(){this._shadingMode=0,this.elapsedTime=NaN,this.loopCount=0,this.context=null,this.scene=null,this.owner=null,this.renderObj=null,this.camera=null,this.viewMatrix=null,this.projectionMatrix=null,this.projectionViewMatrix=null,this.viewport=null,this.worldTransformModifyID=NaN,this.worldShaderValue=new b,this.shaderValue=new b,this.shaderDefs=new Vt,this.renderClip=new F,this.reset()}r(t,"laya.d3.core.render.RenderState");var e=t.prototype;return e.reset=function(){this.worldShaderValue.length=0,this.shaderValue.length=0,this.shaderDefs.setValue(0),w.frameShaderHighPrecision&&this.shaderDefs.setValue(1048576)},a(0,e,"shadingMode",function(){return this._shadingMode},function(t){this.shaderDefs.remove(4==t?8:4),this.shaderDefs.add(t),this._shadingMode=t}),t.VERTEXSHADERING=4,t.PIXELSHADERING=8,t.clientWidth=0,t.clientHeight=0,t}(),W=function(){function t(t){this._owner=null,this._preWorldTransformModifyID=-1,this._localUpdate=!1,this._worldTransformModifyID=0,this._parent=null,this._localPosition=new gt,this._localRotation=new mt(0,0,0,1),this._localScale=new gt(1,1,1),this._localMatrix=new ft,this._position=new gt,this._rotation=new mt(0,0,0,1),this._scale=new gt(1,1,1),this._worldMatrix=new ft,this._forward=new gt,this._up=new gt,this._right=new gt,this._tempMatrix0=new ft,this._tempQuaternion0=new mt,this._tempVector30=new gt,this._owner=t}r(t,"laya.d3.core.Transform3D");var e=t.prototype;return e.translate=function(t,e){void 0===e&&(e=!0),e?(ft.createFromQuaternion(this.localRotation,this._tempMatrix0),gt.transformCoordinate(t,this._tempMatrix0,this._tempVector30),gt.add(this.localPosition,this._tempVector30,this._localPosition),this.localPosition=this._localPosition):(gt.add(this.position,t,this._position),this.position=this._position)},e.rotate=function(t,e,i){void 0===e&&(e=!0),void 0===i&&(i=!0);var n;i?n=t:(gt.scale(t,Math.PI/180,this._tempVector30),n=this._tempVector30),mt.createFromYawPitchRoll(n.y,n.x,n.z,this._tempQuaternion0),e?(mt.multiply(this.localRotation,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(mt.multiply(this._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},e.getWorldMatrix=function(t){return-2===t||t>=0&&this._preWorldTransformModifyID===t?this._worldMatrix:(null!=this._parent?ft.multiply(this._parent.getWorldMatrix(-1===t?-1:-2),this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),t>=0&&(this._preWorldTransformModifyID=t),this._worldMatrix)},e._updateLocalMatrix=function(){ft.createAffineTransformation(this._localPosition,this._localRotation,this._localScale,this._localMatrix)},e._onLocalTransform=function(){this._localUpdate=!0},e._onWorldTransform=function(){this._worldTransformModifyID+=.01/this._owner.id},a(0,e,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(t){this._localMatrix=t,this._localMatrix.decompose(this._localPosition,this._localRotation,this._localScale),this._onWorldTransform()}),a(0,e,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._onLocalTransform(),this._onWorldTransform()}),a(0,e,"position",function(){if(null!==this._parent){var t=this.worldMatrix.elements;this._position.elements[0]=t[12],this._position.elements[1]=t[13],this._position.elements[2]=t[14]}else this._localPosition.cloneTo(this._position);return this._position},function(t){null!==this._parent?(this._parent.worldMatrix.invert(this._tempMatrix0),gt.transformCoordinate(t,this._tempMatrix0,this._localPosition),this.localPosition=this._localPosition):(t.cloneTo(this._localPosition),this.localPosition=this._localPosition)}),a(0,e,"worldMatrix",function(){return this.getWorldMatrix(-1),this._worldMatrix},function(t){null===this._parent?this.localMatrix=t:(this._parent.worldMatrix.invert(this._localMatrix),ft.multiply(this._localMatrix,t,this._localMatrix),this.localMatrix=this._localMatrix)}),a(0,e,"localRotation",function(){return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,e,"rotation",function(){return null!==this._parent?this.worldMatrix.decompose(this._position,this._rotation,this._scale):this._localRotation.cloneTo(this._rotation),this._rotation},function(t){null!==this._parent?(this._parent.rotation.invert(this._tempQuaternion0),mt.multiply(t,this._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(t.cloneTo(this._localRotation),this.localRotation=this._localRotation)}),a(0,e,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._onLocalTransform(),this._onWorldTransform()}),a(0,e,"scale",function(){return null!==this._parent?gt.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scale}),a(0,e,"localRotationEuler",null,function(t){mt.createFromYawPitchRoll(t.y,t.x,t.z,this._localRotation),this._onLocalTransform(),this._onWorldTransform()}),a(0,e,"rotationEuler",null,function(t){mt.createFromYawPitchRoll(t.y,t.x,t.z,this._rotation),this.rotation=this._rotation}),a(0,e,"forward",function(){var t=this.worldMatrix.elements;return this._forward.elements[0]=-t[8],this._forward.elements[1]=-t[9],this._forward.elements[2]=-t[10],this._forward}),a(0,e,"up",function(){var t=this.worldMatrix.elements;return this._up.elements[0]=t[4],this._up.elements[1]=t[5],this._up.elements[2]=t[6],this._up}),a(0,e,"right",function(){var t=this.worldMatrix.elements;return this._right.elements[0]=t[0],this._right.elements[1]=t[1],this._right.elements[2]=t[2],this._right}),t}(),j=function(){function t(e,i){this._currentVertexCount=0,this._currentIndexCount=0,this._elementCount=0,this._vertexDeclaration=null,this._material=null,this._vertexBuffer=null,this._indexBuffer=null,this._lastRenderObjects=null,this._renderObjects=null,this._needReMerage=!1,this.id=0,this._elementCount=0,this._vertexDeclaration=e,this._material=i,this._vertexBuffer=new Ft(this._vertexDeclaration,t.maxVertexCount,35048),this._indexBuffer=new Ut(t.maxIndexCount,35048),this._lastRenderObjects=[],this._renderObjects=[],this._needReMerage=!1,this.id=++t.ID}r(t,"laya.d3.graphics.StaticBatch");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRender":!0}),e.getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e.getIndexBuffer=function(){return this._indexBuffer},e.getBakedVertexs=function(t){return void 0===t&&(t=0),null},e.getBakedIndices=function(){return null},e._finsh=function(){if(this._needReMerage||this._lastRenderObjects.length==this._renderObjects.length||(this._needReMerage=!0),this._currentIndexCount=0,this._currentVertexCount=0,this._needReMerage){this._needReMerage=!1,this._indexBuffer.clear(),this._vertexBuffer.clear(),this._elementCount=0;for(var t=0;t<this._renderObjects.length;t++){var e=this._renderObjects[t],i=e.getBakedVertexs(),n=e.getBakedIndices(),r=this._vertexBuffer.length/this._vertexDeclaration.vertexStride,a=this._indexBuffer.length/2,s=a+n.length,o=this._indexBuffer.getUint16Array();o.set(n,this._indexBuffer.length/2);for(var l=a;s>l;l++)o[l]=r+o[l];this._indexBuffer.length+=2*n.length,this._indexBuffer.setNeedUpload();var h=this._vertexBuffer.getFloat32Array();h.set(i,this._vertexBuffer.length/4),this._vertexBuffer.length+=4*i.length,this._vertexBuffer.setNeedUpload(),this._elementCount+=n.length}}this._lastRenderObjects=this._renderObjects.slice(),this._renderObjects.length=0},e._getShader=function(t,e,i){if(!i)return null;var n=0,r=e.vertexDeclaration.shaderAttribute;r.UV&&(n|=i.shaderDef),r.COLOR&&(n|=32),t.scene.enableFog&&(n|=131072),n>0&&t.shaderDefs.addInt(n);var a=i.getShader(t);return a},e.addRenderObj=function(e){var i=this._currentIndexCount+e.getIndexBuffer().length/2,n=this._currentVertexCount+e.getVertexBuffer().length/this._vertexDeclaration.vertexStride;return n>t.maxVertexCount||i>t.maxIndexCount?!1:(this._renderObjects.push(e),this._needReMerage||-1!==this._lastRenderObjects.indexOf(e)||(this._needReMerage=!0),this._currentIndexCount=i,this._currentVertexCount=n,!0)},e._render=function(t){var e=this._vertexBuffer,i=this._indexBuffer,n=this._material;if(n.normalTexture&&!e.vertexDeclaration.shaderAttribute.TANGENT0){var r=e.getFloat32Array(),a=Dt.GenerateTangent(r,e.vertexDeclaration.vertexStride/4,e.vertexDeclaration.shaderAttribute.POSITION[4]/4,e.vertexDeclaration.shaderAttribute.UV[4]/4,i.getUint16Array()),s=Dt.getVertexTangentDeclaration(e.vertexDeclaration.getVertexElements()),o=Ft.create(s,35044);o.append(a),e.dispose(),e=o}if(e.bind_upload(i),n){var l=this._getShader(t,e,n),h=t.shaderValue.length;if(t.shaderValue.pushArray(e.vertexDeclaration.shaderValues),t.shaderValue.pushValue("MATRIX1",ft.DEFAULT.elements,-1),t.shaderValue.pushValue("MVPMATRIX",t.projectionViewMatrix.elements,t.camera.transform._worldTransformModifyID+t.camera._projectionMatrixModifyID),!n.upload(t,null,l))return t.shaderValue.length=h,!1;t.shaderValue.length=h}return t.context.drawElements(4,this._elementCount,5123,0),A.drawCall++,A.trianglesFaces+=this._elementCount/3,!0},a(0,e,"VertexBufferCount",function(){return 1}),a(0,e,"indexOfHost",function(){return 0}),a(0,e,"currentVertexCount",function(){return this._currentVertexCount}),a(0,e,"currentIndexCount",function(){return this._currentIndexCount}),t.maxVertexCount=65535,
t.maxIndexCount=12e4,t.ID=0,t}(),z=function(){function t(){this._keys=null,this._useFPS=null,this._staticBatchs=null,this._keys=[],this._useFPS=[],this._staticBatchs=[]}r(t,"laya.d3.graphics.StaticBatchManager");var e=t.prototype;return e.getStaticBatchQneue=function(t,e){var i,n=1e3*e.id+t.id;if(-1===this._keys.indexOf(n))this._keys.push(n),this._useFPS.push(A.loopCount),i=new j(t,e),this._staticBatchs.push(i);else{var r=this._keys.indexOf(n);this._useFPS[r]=A.loopCount,i=this._staticBatchs[r]}return i},e.garbageCollection=function(){for(var t=0;t<this._keys.length;t++)this._useFPS[t]<A.loopCount&&(this._keys.splice(t,1),this._useFPS.splice(t,1),this._staticBatchs.splice(t,1),t--)},e._finsh=function(){for(var t=0;t<this._keys.length;t++)this._staticBatchs[t]._finsh()},t.maxVertexDeclaration=1e3,n(t,["maxMaterialCount",function(){return this.maxMaterialCount=Math.floor(2147483.647)}]),t}(),X=function(){function t(e,i){this._id=0,this._shaderValues=null,this._shaderAttribute=null,this._vertexStride=0,this._vertexElements=null,this._id=++t._uniqueIDCounter,this._shaderAttribute={},this._shaderValues=new b,this._vertexStride=e,this._vertexElements=i;for(var n=0;n<i.length;n++){var r=i[n],a=r.elementUsage,s=[t._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];this._shaderValues.pushValue(a,s,-1),this._shaderAttribute[a]=s}}r(t,"laya.d3.graphics.VertexDeclaration");var e=t.prototype;return e.getVertexElements=function(){return this._vertexElements.slice()},e.unBinding=function(){},a(0,e,"id",function(){return this._id}),a(0,e,"shaderAttribute",function(){return this._shaderAttribute}),a(0,e,"shaderValues",function(){return this._shaderValues}),a(0,e,"vertexStride",function(){return this._vertexStride}),t._getTypeSize=function(t){switch(t){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"volor":return 4;case"byte4":return 4;case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},t.getVertexStride=function(e){for(var i=0,n=0;n<e.Length;n++){var r=e[n],a=r.offset+t._getTypeSize(r.elementFormat);a>i&&(i=a)}return i},t._uniqueIDCounter=1,t}(),q=function(){function t(t,e,i){this.offset=0,this.elementFormat=null,this.elementUsage=null,this.offset=t,this.elementFormat=e,this.elementUsage=i}return r(t,"laya.d3.graphics.VertexElement"),t}(),Z=(function(){function t(){}return r(t,"laya.d3.graphics.VertexElementFormat"),t.Single="single",t.Vector2="vector2",t.Vector3="vector3",t.Vector4="vector4",t.Color="volor",t.Byte4="byte4",t.Short2="short2",t.Short4="short4",t.NormalizedShort2="normalizedshort2",t.NormalizedShort4="normalizedshort4",t.HalfVector2="halfvector2",t.HalfVector4="halfvector4",t}(),function(){function t(){}return r(t,"laya.d3.graphics.VertexElementUsage"),t.POSITION0="POSITION",t.COLOR0="COLOR",t.TEXTURECOORDINATE0="UV",t.NORMAL0="NORMAL",t.BINORMAL0="BINORMAL",t.TANGENT0="TANGENT0",t.BLENDINDICES0="BLENDINDICES",t.BLENDWEIGHT0="BLENDWEIGHT",t.DEPTH0="DEPTH",t.FOG0="FOG",t.POINTSIZE0="POINTSIZE",t.SAMPLE0="SAMPLE",t.TESSELLATEFACTOR0="TESSELLATEFACTOR",t.COLOR1="COLOR1",t.NEXTTEXTURECOORDINATE0="NEXTUV",t.TEXTURECOORDINATE1="UV1",t.NEXTTEXTURECOORDINATE1="NEXTUV1",t.CORNERTEXTURECOORDINATE0="CORNERTEXTURECOORDINATE",t.VELOCITY0="VELOCITY",t.STARTCOLOR0="STARTCOLOR",t.ENDCOLOR0="ENDCOLOR",t.SIZEROTATION0="SIZEROTATION",t.RADIUS0="RADIUS",t.RADIAN0="RADIAN",t.AGEADDSCALE0="AGEADDSCALE",t.TIME0="TIME",t}(),function(){function t(t,e,i){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=t,this._textureCoordinate0=e,this._time=i}r(t,"laya.d3.graphics.VertexGlitter");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(24,[new q(0,"vector3","POSITION"),new q(12,"vector2","UV"),new q(20,"single","TIME")])}]),t}()),Y=function(){function t(t,e,i,n,r,a,s,o,l,h){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=t,this._position=e,this._velocity=i,this._startColor=n,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=l,this._time=h}r(t,"laya.d3.graphics.VertexParticle");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"position",function(){return this._position}),a(0,e,"radius",function(){return this._radius}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"endColor",function(){return this._endColor}),a(0,e,"radian",function(){return this._radian}),a(0,e,"sizeRotation",function(){return this._sizeRotation}),a(0,e,"ageAddScale",function(){return this._ageAddScale}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(116,[new q(0,"vector4","CORNERTEXTURECOORDINATE"),new q(16,"vector3","POSITION"),new q(28,"vector3","VELOCITY"),new q(40,"vector4","STARTCOLOR"),new q(56,"vector4","ENDCOLOR"),new q(72,"vector3","SIZEROTATION"),new q(84,"vector2","RADIUS"),new q(92,"vector4","RADIAN"),new q(108,"single","AGEADDSCALE"),new q(112,"single","TIME")])}]),t}(),Q=function(){function t(t,e,i){this._position=null,this._normal=null,this._color=null,this._position=t,this._normal=e,this._color=i}r(t,"laya.d3.graphics.VertexPositionNormalColor");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(40,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR")])}]),t}(),K=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalColorSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(72,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector4","BLENDWEIGHT"),new q(56,"vector4","BLENDINDICES")])}]),t}(),J=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(84,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector4","BLENDWEIGHT"),new q(56,"vector4","BLENDINDICES"),new q(72,"vector3","TANGENT0")])}]),t}(),$=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(52,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector3","TANGENT0")])}]),t}(),tt=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(48,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV")])}]),t}(),et=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(56,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector2","UV1")])}]),t}(),it=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"color",function(){return this._color}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(88,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector2","UV1"),new q(56,"vector4","BLENDWEIGHT"),new q(72,"vector4","BLENDINDICES")])}]),t}(),nt=(function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0SkinTangent=function(t,e,i,n,r,a,s,o){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(100,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector2","UV1"),new q(56,"vector4","BLENDWEIGHT"),new q(72,"vector4","BLENDINDICES"),new q(88,"vector3","TANGENT0")])}]),t}(),function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0Tangent=function(t,e,i,n,r,a){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a},a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(68,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector2","UV1"),new q(56,"vector3","TANGENT0")])}]),t}(),function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(80,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector4","BLENDWEIGHT"),new q(64,"vector4","BLENDINDICES")])}]),t}()),rt=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(92,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector4","BLENDWEIGHT"),new q(64,"vector4","BLENDINDICES"),new q(80,"vector3","TANGENT0")])}]),t}(),at=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"color",function(){return this._color}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(60,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector4","COLOR"),new q(40,"vector2","UV"),new q(48,"vector3","TANGENT0")])}]),t}(),st=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNormalTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(32,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV")])}]),t}(),ot=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(40,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector2","UV1")])}]),t}(),lt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(72,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector2","UV1"),new q(40,"vector4","BLENDWEIGHT"),new q(56,"vector4","BLENDINDICES")])}]),t}(),ht=(function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0SkinTangent=function(t,e,i,n,r,a,s){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(84,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector2","UV1"),new q(40,"vector4","BLENDWEIGHT"),new q(56,"vector4","BLENDINDICES"),new q(72,"vector3","TANGENT0")])}]),t}(),function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0Tangent=function(t,e,i,n,r){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r},a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(52,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector2","UV1"),new q(40,"vector3","TANGENT0")])}]),t}(),function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(64,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector4","BLENDWEIGHT"),new q(48,"vector4","BLENDINDICES")])}]),t}()),ut=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"normal",function(){return this._normal}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(76,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector4","BLENDWEIGHT"),new q(48,"vector4","BLENDINDICES"),new q(64,"vector3","TANGENT0")])}]),t}(),_t=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"normal",function(){return this._normal}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new X(44,[new q(0,"vector3","POSITION"),new q(12,"vector3","NORMAL"),new q(24,"vector2","UV"),new q(32,"vector3","TANGENT0")])}]),t}(),ct=(function(){function t(){}return r(t,"laya.d3.Laya3D"),t.init=function(e,n){return w.enable()?(m.parserMap={TextureCube:t._loadTextureCube},M.changeWebGLSize=function(t,e){w.onStageResize(t,e),k.clientWidth=t,k.clientHeight=e},T.is3DMode=!0,i.init(e,n),U.__init__(),Vt.__init__(),Ct.__init__(),Et.__init__(),void t._regClassforJson()):void alert("Laya3D init err,must support webGL!")},t._regClassforJson=function(){h.regClass("Sprite3D",bt),h.regClass("SkyMesh",Ht),h.regClass("Mesh",Ot),h.regClass("Material",At)},t._loadTextureCube=function(t){i.loader.load(t.url,c.create(null,function(e){var i=V.basePath;V.basePath=V.getPath(V.formatURL(t.url));var n=new S([e.px,e.nx,e.py,e.ny,e.pz,e.nz],e.size);V.basePath=i,n.on("loaded",null,function(e){var i=new y(n);t.endLoad(i)})}),null,"json",1,!1)},t}(),function(){function t(t,e,i){this._strings=["BLOCK","DATA","STRINGS"],this._fileData=null,this._readData=null,this._meshTemplet=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._materials=new Array,this._meshTemplet=e,this._onLoaded(t,i)}r(t,"laya.d3.loaders.LoadModel");var e=t.prototype;return e._onLoaded=function(t,e){var i=V.basePath;V.basePath=V.getPath(V.formatURL(e)),this._fileData=t,this._readData=new l(this._fileData),this._readData.pos=0;this._readData.readUTFString();this.READ_BLOCK();for(var n=0;n<this._BLOCK.count;n++){var r=this._readData.getUint16(),a=this._strings[r],s=this["READ_"+a];if(null==s)throw new Error("model file err,no this function:"+r+" "+a);if(!s.call(this))break}return V.basePath=i,this._meshTemplet},e.onError=function(){},e._readString=function(){return this._strings[this._readData.getUint16()]},e.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},e.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},e.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var t=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var e=0;e<this._STRINGS.size;e++)this._strings[e]=this._readData.readUTFString();return this._readData.pos=t,!0},e.READ_MATERIAL=function(){var t=this,e=this._readData.getUint16(),i=this._readString(),n=this._readString();if("null"!==n){n=V.formatURL(n);var r=m.getRes(n);if(r)this._materials[e]=r,r.loaded?this._meshTemplet.event("loaded",this._meshTemplet):r.once("loaded",null,function(){r.loaded=!0,t._meshTemplet.event("loaded",t._meshTemplet)});else{this._materials[e]=r=new At,r.setShaderName(i);var a=new m,s=function(e){var i=V.basePath;V.basePath=V.getPath(V.formatURL(n)),h.createByJson(e,r,null,c.create(null,Dt._parseMaterial,null,!1)),V.basePath=i,r.loaded=!0,r.event("loaded",r),t._meshTemplet.event("loaded",t._meshTemplet)};a.once("complete",null,s),a.load(n,"text",!1),m.cacheRes(n,r)}}else this._materials[e]=new At,this._meshTemplet.event("loaded",this._meshTemplet);return!0},e.READ_MESH=function(){this._readString();return this._meshTemplet||(this._meshTemplet=new Bt),this._meshTemplet.materials=this._materials,!0},e.READ_SUBMESH=function(){var e=(this._readString(),this._readData.getUint8()),i=this._readString();this._shaderAttributes=i.match(t._attrReg);var n=this._readData.getUint32(),r=this._readData.getUint32(),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.getUint32(),h=this._readData.getUint32(),u=this._readData.getUint32(),_=this._readData.__getBuffer(),c=new Mt(this._meshTemplet);c.material=e,c.verticesIndices=new Uint32Array(_.slice(a+this._DATA.offset,a+this._DATA.offset+s));var d=this._getVertexDeclaration(),f=Ft.create(d,l/d.vertexStride,35044);f.append(new Uint8Array(_,o+this._DATA.offset,l)),c.setVB(f);for(var m=f.vertexDeclaration.getVertexElements(),p=0;p<m.length;p++)c._bufferUsage[m[p].elementUsage]=f;var v=Ut.create(r/2,35044);return v.append(new Uint8Array(_,n+this._DATA.offset,r)),c.setIB(v,r/2),v.getUint16Array(),c._setBoneDic(new Uint8Array(_,h+this._DATA.offset,u)),this._meshTemplet.add(c),!0},e.READ_DATAAREA=function(){return!1},e._getVertexDeclaration=function(){for(var t=!1,e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=0;o<this._shaderAttributes.length;o+=8)switch(this._shaderAttributes[o]){case"POSITION":t=!0;break;case"NORMAL":e=!0;break;case"COLOR":i=!0;break;case"UV":n=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var l;return t&&e&&i&&n&&r&&a&&s?l=it.vertexDeclaration:t&&e&&n&&r&&a&&s?l=lt.vertexDeclaration:t&&e&&i&&n&&a&&s?l=nt.vertexDeclaration:t&&e&&n&&a&&s?l=ht.vertexDeclaration:t&&e&&i&&a&&s?l=K.vertexDeclaration:t&&e&&i&&n&&r?l=et.vertexDeclaration:t&&e&&n&&r?l=ot.vertexDeclaration:t&&e&&i&&n?l=tt.vertexDeclaration:t&&e&&n?l=st.vertexDeclaration:t&&e&&i&&(l=Q.vertexDeclaration),
l},a(0,e,"mesh",function(){return this._meshTemplet}),t._attrReg=new RegExp("(\\w+)|([:,;])","g"),t}()),dt=(function(){function t(t,e){this.min=null,this.max=null,this.min=t,this.max=e}r(t,"laya.d3.math.BoundBox");var e=t.prototype;return e.GetCorners=function(t){t.length=8;var e=this.min.elements,i=this.max.elements,n=e[0],r=e[1],a=e[2],s=i[0],o=i[1],l=i[2];t[0]=new gt(n,o,l),t[1]=new gt(s,o,l),t[2]=new gt(s,r,l),t[3]=new gt(n,r,l),t[4]=new gt(n,o,a),t[5]=new gt(s,o,a),t[6]=new gt(s,r,a),t[7]=new gt(n,r,a)},t.fromPoints=function(e,i){if(null==e)throw new Error("points");for(var n=new gt(Number.MAX_VALUE),r=new gt(-Number.MAX_VALUE),a=0;a<e.length;++a)gt.min(n,e[a],n),gt.max(r,e[a],r);i=new t(n,r)},t}(),function(){function t(t,e){this.center=null,this.radius=NaN,this.center=t,this.radius=e}return r(t,"laya.d3.math.BoundSphere"),t.fromSubPoints=function(t,e,i,n){if(null==t)throw new Error("points");if(0>e||e>=t.length)throw new Error("start"+e+"Must be in the range [0, "+(t.length-1)+"]");if(0>i||e+i>t.length)throw new Error("count"+i+"Must be in the range <= "+t.length+"}");for(var r=e+i,a=gt.ZERO,s=e;r>s;++s)gt.add(t[s],a,a);gt.scale(a,1/i,a);var o=0;for(s=e;r>s;++s){var l=gt.distanceSquared(a,t[s]);l>o&&(o=l)}o=Math.sqrt(o),n.center=a,n.radius=o},t.fromPoints=function(e,i){if(null==e)throw new Error("points");t.fromSubPoints(e,0,e.length,i)},t}(),function(){function t(){}return r(t,"laya.d3.math.MathUtils"),t.isZero=function(e){return Math.abs(e)<t.zeroTolerance},n(t,["zeroTolerance",function(){return this.zeroTolerance=1e-6}]),t}()),ft=(function(){function t(){var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}r(t,"laya.d3.math.Matrix3x3");var e=t.prototype;return e.determinant=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],a=t[4],s=t[5],o=t[6],l=t[7],h=t[8];return e*(h*a-s*l)+i*(-h*r+s*o)+n*(l*r-a*o)},e.translate=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=n[0],s=n[1],o=n[2],l=n[3],h=n[4],u=n[5],_=n[6],c=n[7],d=n[8],f=r[0],m=r[1];i[0]=a,i[1]=s,i[2]=o,i[3]=l,i[4]=h,i[5]=u,i[6]=f*a+m*l+_,i[7]=f*s+m*h+c,i[8]=f*o+m*u+d},e.rotate=function(t,e){var i=e.elements,n=this.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=n[4],h=n[5],u=n[6],_=n[7],c=n[8],d=Math.sin(t),f=Math.cos(t);i[0]=f*r+d*o,i[1]=f*a+d*l,i[2]=f*s+d*h,i[3]=f*o-d*r,i[4]=f*l-d*a,i[5]=f*h-d*s,i[6]=u,i[7]=_,i[8]=c},e.scale=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=r[0],s=r[1];i[0]=a*n[0],i[1]=a*n[1],i[2]=a*n[2],i[3]=s*n[3],i[4]=s*n[4],i[5]=s*n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],h=i[6],u=i[7],_=i[8],c=_*o-l*u,d=-_*s+l*h,f=u*s-o*h,m=n*c+r*d+a*f;m||(t=null),m=1/m,e[0]=c*m,e[1]=(-_*r+a*u)*m,e[2]=(l*r-a*o)*m,e[3]=d*m,e[4]=(_*n-a*h)*m,e[5]=(-l*n+a*s)*m,e[6]=f*m,e[7]=(-u*n+r*h)*m,e[8]=(o*n-r*s)*m},e.transpose=function(t){var e=t.elements,i=this.elements;if(t===this){var n=i[1],r=i[2],a=i[5];e[1]=i[3],e[2]=i[6],e[3]=n,e[5]=i[7],e[6]=r,e[7]=a}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]},e.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;9>e;++e)n[e]=i[e]},e.copyFrom=function(t){var e,i,n;if(i=t.elements,n=this.elements,i!==n)for(e=0;9>e;++e)n[e]=i[e]},e.copyFromArray=function(t){var e,i;if(i=this.elements,t!==i)for(e=0;9>e;++e)i[e]=t[e]},t.createFromTranslation=function(t,e){var i=(e.elements,t.elements);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=i[0],e[7]=i[1],e[8]=1},t.createFromRotation=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[0]=r,i[1]=n,i[2]=0,i[3]=-n,i[4]=r,i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromScaling=function(t,e){var i=e.elements,n=t.elements;i[0]=n[0],i[1]=0,i[2]=0,i[3]=0,i[4]=n[1],i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromMatrix4x4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=r[3],u=r[4],_=r[5],c=r[6],d=r[7],f=r[8],m=a[0],p=a[1],v=a[2],g=a[3],T=a[4],x=a[5],I=a[6],M=a[7],C=a[8];n[0]=m*s+p*h+v*c,n[1]=m*o+p*u+v*d,n[2]=m*l+p*_+v*f,n[3]=g*s+T*h+x*c,n[4]=g*o+T*u+x*d,n[5]=g*l+T*_+x*f,n[6]=I*s+M*h+C*c,n[7]=I*o+M*u+C*d,n[8]=I*l+M*_+C*f},t.DEFAULT=new t,t}(),function(){function t(){var t=this.elements=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1}r(t,"laya.d3.math.Matrix4x4");var e=t.prototype;return e.decompose=function(e,i,n){var r=this.elements,a=e.elements,s=i.elements,o=n.elements;if(a[0]=r[12],a[1]=r[13],a[2]=r[14],o[0]=Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]),o[1]=Math.sqrt(r[4]*r[4]+r[5]*r[5]+r[6]*r[6]),o[2]=Math.sqrt(r[8]*r[8]+r[9]*r[9]+r[10]*r[10]),dt.isZero(o[0])||dt.isZero(o[1])||dt.isZero(o[2]))return s[0]=s[1]=s[2]=0,s[3]=1,!1;var l=new t,h=l.elements;return h[0]=r[0]/o[0],h[1]=r[1]/o[0],h[2]=r[2]/o[0],h[4]=r[4]/o[1],h[5]=r[5]/o[1],h[6]=r[6]/o[1],h[8]=r[8]/o[2],h[9]=r[9]/o[2],h[10]=r[10]/o[2],l[15]=1,mt.createFromMatrix4x4(l,i),!0},e.normalize=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=Math.sqrt(e*e+i*i+n*n);return r?void(1!=r&&(r=1/r,t[0]=e*r,t[1]=i*r,t[2]=n*r)):(t[0]=0,t[1]=0,void(t[2]=0))},e.transpose=function(){var t,e;return t=this.elements,e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},e.invert=function(t){var e=this.elements,i=t.elements,n=e[0],r=e[1],a=e[2],s=e[3],o=e[4],l=e[5],h=e[6],u=e[7],_=e[8],c=e[9],d=e[10],f=e[11],m=e[12],p=e[13],v=e[14],g=e[15],T=n*l-r*o,x=n*h-a*o,I=n*u-s*o,M=r*h-a*l,C=r*u-s*l,D=a*u-s*h,E=_*p-c*m,A=_*v-d*m,y=_*g-f*m,V=c*v-d*p,b=c*g-f*p,P=d*g-f*v,w=T*P-x*b+I*V+M*y-C*A+D*E;0!==Math.abs(w)&&(w=1/w,i[0]=(l*P-h*b+u*V)*w,i[1]=(a*b-r*P-s*V)*w,i[2]=(p*D-v*C+g*M)*w,i[3]=(d*C-c*D-f*M)*w,i[4]=(h*y-o*P-u*A)*w,i[5]=(n*P-a*y+s*A)*w,i[6]=(v*I-m*D-g*x)*w,i[7]=(_*D-d*I+f*x)*w,i[8]=(o*b-l*y+u*E)*w,i[9]=(r*y-n*b-s*E)*w,i[10]=(m*C-p*I+g*T)*w,i[11]=(c*I-_*C-f*T)*w,i[12]=(l*A-o*V-h*E)*w,i[13]=(n*V-r*A+a*E)*w,i[14]=(p*x-m*M-v*T)*w,i[15]=(_*M-c*x+d*T)*w)},e.identity=function(){var t=this.elements;t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[5]=t[10]=t[15]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;16>e;++e)n[e]=i[e]},e.copyFrom=function(t){var e,i,n;if(i=t.elements,n=this.elements,i!==n)for(e=0;16>e;++e)n[e]=i[e]},e.copyFromArray=function(t){var e,i;if(i=this.elements,t!==i)for(e=0;16>e;++e)i[e]=t[e]},t.createRotationX=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=r,i[6]=n,i[9]=-n},t.createRotationY=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=r,i[2]=-n,i[8]=n},t.createRotationZ=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=r,i[1]=n,i[4]=-n},t.createTranslate=function(t,e){var i=t.elements,n=e.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},t.createScaling=function(t,e){var i=t.elements,n=e.elements;n[0]=i[0],n[5]=i[1],n[10]=i[2],n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1},t.multiply=function(t,e,i){var n,r,a,s,o,l,h,u;if(r=i.elements,a=t.elements,s=e.elements,r===s)for(s=new Float32Array(16),n=0;16>n;++n)s[n]=r[n];for(n=0;4>n;n++)o=a[n],l=a[n+4],h=a[n+8],u=a[n+12],r[n]=o*s[0]+l*s[1]+h*s[2]+u*s[3],r[n+4]=o*s[4]+l*s[5]+h*s[6]+u*s[7],r[n+8]=o*s[8]+l*s[9]+h*s[10]+u*s[11],r[n+12]=o*s[12]+l*s[13]+h*s[14]+u*s[15]},t.createFromQuaternion=function(t,e){var i=e.elements,n=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=r+r,h=a+a,u=s+s,_=r*l,c=a*l,d=a*h,f=s*l,m=s*h,p=s*u,v=o*l,g=o*h,T=o*u;i[0]=1-d-p,i[1]=c+T,i[2]=f-g,i[3]=0,i[4]=c-T,i[5]=1-_-p,i[6]=m+v,i[7]=0,i[8]=f+g,i[9]=m-v,i[10]=1-_-d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,e[15]=1},t.createAffineTransformation=function(t,e,i,n){var r=t.elements,a=e.elements,s=i.elements,o=n.elements,l=a[0],h=a[1],u=a[2],_=a[3],c=l+l,d=h+h,f=u+u,m=l*c,p=l*d,v=l*f,g=h*d,T=h*f,x=u*f,I=_*c,M=_*d,C=_*f,D=s[0],E=s[1],A=s[2];o[0]=(1-(g+x))*D,o[1]=(p+C)*D,o[2]=(v-M)*D,o[3]=0,o[4]=(p-C)*E,o[5]=(1-(m+x))*E,o[6]=(T+I)*E,o[7]=0,o[8]=(v+M)*A,o[9]=(T-I)*A,o[10]=(1-(m+g))*A,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},t.createLookAt=function(t,e,i,n){var r,a,s,o,l,h,u,_,c,d,f=t.elements,m=e.elements,p=i.elements,v=n.elements,g=f[0],T=f[1],x=f[2],I=p[0],M=p[1],C=p[2],D=m[0],E=m[1],A=m[2];return Math.abs(g-D)<dt.zeroTolerance&&Math.abs(T-E)<dt.zeroTolerance&&Math.abs(x-A)<dt.zeroTolerance?void n.identity():(u=g-D,_=T-E,c=x-A,d=1/Math.sqrt(u*u+_*_+c*c),u*=d,_*=d,c*=d,r=M*c-C*_,a=C*u-I*c,s=I*_-M*u,d=Math.sqrt(r*r+a*a+s*s),d?(d=1/d,r*=d,a*=d,s*=d):r=a=s=0,o=_*s-c*a,l=c*r-u*s,h=u*a-_*r,d=Math.sqrt(o*o+l*l+h*h),d?(d=1/d,o*=d,l*=d,h*=d):o=l=h=0,v[0]=r,v[1]=o,v[2]=u,v[3]=0,v[4]=a,v[5]=l,v[6]=_,v[7]=0,v[8]=s,v[9]=h,v[10]=c,v[11]=0,v[12]=-(r*g+a*T+s*x),v[13]=-(o*g+l*T+h*x),v[14]=-(u*g+_*T+c*x),void(v[15]=1))},t.createPerspective=function(t,e,i,n,r){var a=r.elements,s=1/Math.tan(t/2),o=1/(i-n);a[0]=s/e,a[5]=s,a[10]=(n+i)*o,a[11]=-1,a[14]=2*n*i*o,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},t.createOrthogonal=function(t,e,i,n,r,a,s){var o=s.elements,l=1/(t-e),h=1/(i-n),u=1/(r-a);o[0]=-2*l,o[5]=-2*h,o[10]=2*u,o[12]=(t+e)*l,o[13]=(n+i)*h,o[14]=(a+r)*u,o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1},t.TEMP=new t,t.DEFAULT=new t,t}()),mt=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.elements[0]=t,this.elements[1]=e,this.elements[2]=i,this.elements[3]=n}r(t,"laya.d3.math.Quaternion");var e=t.prototype;return e.scaling=function(t,e){var i=e.elements,n=this.elements;i[0]=n[0]*t,i[1]=n[1]*t,i[2]=n[2]*t,i[3]=n[3]*t},e.normalize=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=r*o,e[2]=a*o,e[3]=s*o)},e.length=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3];return Math.sqrt(e*e+i*i+n*n+r*r)},e.rotateX=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h+o*l,i[1]=a*h+s*l,i[2]=s*h-a*l,i[3]=o*h-r*l},e.rotateY=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h-s*l,i[1]=a*h+o*l,i[2]=s*h+r*l,i[3]=o*h-a*l},e.rotateZ=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h+a*l,i[1]=a*h-r*l,i[2]=s*h+o*l,i[3]=o*h-s*l},e.getYawPitchRoll=function(e){gt.transformQuat(gt.ForwardRH,this,t.TEMPVector31),gt.transformQuat(gt.Up,this,t.TEMPVector32);var i=t.TEMPVector32.elements;t.angleTo(gt.ZERO,t.TEMPVector31,t.TEMPVector33);var n=t.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=t.arcTanAngle(i[2],i[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=t.arcTanAngle(-i[2],-i[0]),n[2]=0):(ft.createRotationY(-n[1],t.TEMPMatrix0),ft.createRotationX(-n[0],t.TEMPMatrix1),gt.transformCoordinate(t.TEMPVector32,t.TEMPMatrix0,t.TEMPVector32),gt.transformCoordinate(t.TEMPVector32,t.TEMPMatrix1,t.TEMPVector32),n[2]=t.arcTanAngle(i[1],-i[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var r=e.elements;r[0]=n[1],r[1]=n[0],r[2]=n[2]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s,l=o?1/o:0;e[0]=-n*l,e[1]=-r*l,e[2]=-a*l,e[3]=s*l},e.identity=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;4>e;++e)n[e]=i[e]},e.copyFrom=function(t){var e,i,n;if(i=t.elements,n=this.elements,i!==n)for(e=0;4>e;++e)n[e]=i[e]},e.copyFromArray=function(t){var e,i;if(i=this.elements,t!==i)for(e=0;4>e;++e)i[e]=t[e]},a(0,e,"x",function(){return this.elements[0]}),a(0,e,"y",function(){return this.elements[1]}),a(0,e,"z",function(){return this.elements[2]}),a(0,e,"w",function(){return this.elements[3]}),t.createFromYawPitchRoll=function(t,e,i,n){var r=.5*i,a=.5*e,s=.5*t,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),u=Math.cos(a),_=Math.sin(s),c=Math.cos(s),d=n.elements;d[0]=c*h*l+_*u*o,d[1]=_*u*l-c*h*o,d[2]=c*u*o-_*h*l,d[3]=c*u*l+_*h*o},t.multiply=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],l=n[2],h=n[3],u=r[0],_=r[1],c=r[2],d=r[3],f=o*c-l*_,m=l*u-s*c,p=s*_-o*u,v=s*u+o*_+l*c;a[0]=s*d+u*h+f,a[1]=o*d+_*h+m,a[2]=l*d+c*h+p,a[3]=h*d-v},t.arcTanAngle=function(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):0>t?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0},t.angleTo=function(e,i,n){gt.subtract(i,e,t.TEMPVector30),gt.normalize(t.TEMPVector30,t.TEMPVector30),n.elements[0]=Math.asin(t.TEMPVector30.y),n.elements[1]=t.arcTanAngle(-t.TEMPVector30.z,-t.TEMPVector30.x)},t.createFromAxisAngle=function(t,e,i){var n=i.elements,r=t.elements;e=.5*e;var a=Math.sin(e);n[0]=a*r[0],n[1]=a*r[1],n[2]=a*r[2],n[3]=Math.cos(e)},t.createFromMatrix3x3=function(t,e){var i,n=e.elements,r=t.elements,a=r[0]+r[4]+r[8];if(a>0)i=Math.sqrt(a+1),n[3]=.5*i,i=.5/i,n[0]=(r[5]-r[7])*i,n[1]=(r[6]-r[2])*i,n[2]=(r[1]-r[3])*i;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;i=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*l+l]+1),n[s]=.5*i,i=.5/i,n[3]=(r[3*o+l]-r[3*l+o])*i,n[o]=(r[3*o+s]+r[3*s+o])*i,n[l]=(r[3*l+s]+r[3*s+l])*i}},t.createFromMatrix4x4=function(t,e){var i,n,r=t.elements,a=e.elements,s=r[0]+r[5]+r[10];s>0?(i=Math.sqrt(s+1),a[3]=.5*i,i=.5/i,a[0]=(r[6]-r[9])*i,a[1]=(r[8]-r[2])*i,a[2]=(r[1]-r[4])*i):r[0]>=r[5]&&r[0]>=r[10]?(i=Math.sqrt(1+r[0]-r[5]-r[10]),n=.5/i,a[0]=.5*i,a[1]=(r[1]+r[4])*n,a[2]=(r[2]+r[8])*n,a[3]=(r[6]-r[9])*n):r[5]>r[10]?(i=Math.sqrt(1+r[5]-r[0]-r[10]),n=.5/i,a[0]=(r[4]+r[1])*n,a[1]=.5*i,a[2]=(r[9]+r[6])*n,a[3]=(r[8]-r[2])*n):(i=Math.sqrt(1+r[10]-r[0]-r[5]),n=.5/i,a[0]=(r[8]+r[2])*n,a[1]=(r[9]+r[6])*n,a[2]=.5*i,a[3]=(r[1]-r[4])*n)},t.slerp=function(t,e,i,n){var r,a,s,o,l,h=t.elements,u=e.elements,_=n.elements,c=h[0],d=h[1],f=h[2],m=h[3],p=u[0],v=u[1],g=u[2],T=u[3];return a=c*p+d*v+f*g+m*T,0>a&&(a=-a,p=-p,v=-v,g=-g,T=-T),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-i)*r)/s,l=Math.sin(i*r)/s):(o=1-i,l=i),_[0]=o*c+l*p,_[1]=o*d+l*v,_[2]=o*f+l*g,_[3]=o*m+l*T,_},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h),r[3]=u+i*(s[3]-u)},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},t.dot=function(t,e){var i=t.elements,n=e.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3]},t.DEFAULT=new t,n(t,["TEMPVector30",function(){return this.TEMPVector30=new gt},"TEMPVector31",function(){return this.TEMPVector31=new gt},"TEMPVector32",function(){return this.TEMPVector32=new gt},"TEMPVector33",function(){return this.TEMPVector33=new gt},"TEMPMatrix0",function(){return this.TEMPMatrix0=new ft},"TEMPMatrix1",function(){return this.TEMPMatrix1=new ft}]),t}(),pt=function(){function t(t,e){this.origin=gt.ZERO,this.direction=gt.ONE,t=t,e=e}return r(t,"laya.d3.math.Ray"),t}(),vt=function(){function t(t,e){this.elements=new Float32Array(2),void 0===t&&(t=0),void 0===e&&(e=0);var i=this.elements;i[0]=t,i[1]=e}r(t,"laya.d3.math.Vector2");var e=t.prototype;return e.clone=function(t){var e=this.elements,i=t.elements;e[0]=i[0],e[1]=i[1]},a(0,e,"x",function(){return this.elements[0]}),a(0,e,"y",function(){return this.elements[1]}),n(t,["ZERO",function(){return this.ZERO=new t(0,0)},"ONE",function(){return this.ONE=new t(1,1)}]),t}(),gt=function(){function t(t,e,i){this.elements=new Float32Array(3),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var n=this.elements;n[0]=t,n[1]=e,n[2]=i}r(t,"laya.d3.math.Vector3");var e=t.prototype;return e.copyFrom=function(t){var e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],this},e.clone=function(){var e=new t,i=e.elements,n=this.elements;return i[0]=n[0],i[1]=n[1],i[2]=n[2],e},e.cloneTo=function(t){var e=t.elements,i=this.elements;e[0]=i[0],e[1]=i[1],e[2]=i[2]},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),a(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),t.distanceSquared=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return r*r+a*a+s*s},t.min=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2])},t.max=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2])},t.transformQuat=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*l-_*o,f=c*o+_*s-h*l,m=c*l+h*o-u*s,p=-h*s-u*o-_*l;n[0]=d*c+p*-h+f*-_-m*-u,n[1]=f*c+p*-u+m*-h-d*-_,n[2]=m*c+p*-_+d*-u-f*-h},t.scalarLength=function(t){var e=t.elements,i=e[0],n=e[1],r=e[2];return Math.sqrt(i*i+n*n+r*r)},t.normalize=function(t,e){var i=t.elements,n=e.elements,r=i[0],a=i[1],s=i[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),n[0]=i[0]*o,n[1]=i[1]*o,n[2]=i[2]*o)},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2]},t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h)},t.transformV3ToV3=function(e,i,n){var r=new Tt;t.transformV3ToV4(e,i,r);var a=r.elements,s=n.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},t.transformV3ToV4=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=e.elements,l=i.elements;l[0]=r*o[0]+a*o[4]+s*o[8]+o[12],l[1]=r*o[1]+a*o[5]+s*o[9]+o[13],l[2]=r*o[2]+a*o[6]+s*o[10]+o[14],l[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},t.transformCoordinate=function(e,i,n){var r=t.TEMPVec4.elements,a=e.elements,s=a[0],o=a[1],l=a[2],h=i.elements;r[0]=s*h[0]+o*h[4]+l*h[8]+h[12],r[1]=s*h[1]+o*h[5]+l*h[9]+h[13],r[2]=s*h[2]+o*h[6]+l*h[10]+h[14],r[3]=1/(s*h[3]+o*h[7]+l*h[11]+h[15]);var u=n.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2]},t.subtract=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2]},t.cross=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],l=n[2],h=r[0],u=r[1],_=r[2];a[0]=o*_-l*u,a[1]=l*h-s*_,a[2]=s*u-o*h},t.dot=function(t,e){var i=t.elements,n=e.elements,r=i[0]*n[0]+i[1]*n[1]+i[2]*n[2];return r},n(t,["TEMPVec4",function(){return this.TEMPVec4=new Tt},"ZERO",function(){return this.ZERO=new t(0,0,0)},"ONE",function(){return this.ONE=new t(1,1,1)},"UnitX",function(){return this.UnitX=new t(1,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new t(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new t(0,0,1)},"Up",function(){return this.Up=new t(0,1,0)}]),t}(),Tt=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var r=this.elements;r[0]=t,r[1]=e,r[2]=i,r[3]=n}r(t,"laya.d3.math.Vector4");var e=t.prototype;return e.copyFrom=function(t){var e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],this},a(0,e,"x",function(){return this.elements[0]}),a(0,e,"y",function(){return this.elements[1]}),a(0,e,"z",function(){return this.elements[2]}),a(0,e,"w",function(){return this.elements[3]}),t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h),r[3]=u+i*(s[3]-u)},n(t,["ZERO",function(){return this.ZERO=new t}]),t}(),xt=function(){function t(t,e,i,n){this.minDepth=-1,this.maxDepth=1,this.x=t,this.y=e,this.width=i,this.height=n}r(t,"laya.d3.math.Viewport");var e=t.prototype;return e.project=function(t,e,i){gt.transformV3ToV3(t,e,i);var n=t.elements,r=e.elements,a=i.elements,s=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(-a[1]+1)*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},e.unprojectFromMat=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements;a[0]=(n[0]-this.x)/this.width*2-1,a[1]=-((n[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(n[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];gt.transformV3ToV3(i,e,i),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},e.unprojectFromWVP=function(t,e,i,n){var r=new ft;ft.multiply(e,i,r),ft.multiply(r,n,r),r.invert(r);var a=new gt;return this.unprojectFromMat(t,r,a),a},t}(),It=function(){function t(t){this.texture=null,this._vertices=null,this._vertexBuffer=null,this._floatCountPerVertex=6,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this._posShaderValue=[3,5126,!1,24,0],this._uvShaderValue=[2,5126,!1,24,12],this._timeShaderValue=[1,5126,!1,24,20],this._sharderNameID=0,this._shader=null,this.numPositionMode=0,this.numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastAddTime=NaN,this.scLeft=null,this.scRight=null,this.setting=null,this._tempVector0=new gt,this._tempVector1=new gt,this._tempVector2=new gt,this._tempVector3=new gt,this._shaderValue=new b,this.posModeLastPosition0=new gt,this.posModeLastPosition1=new gt,this.posModePosition0=new gt,this.posModePosition1=new gt,this.posVelModePosition0=new gt,this.posVelModeVelocity0=new gt,this.posVelModePosition1=new gt,this.posVelModeVelocity1=new gt,this._lastAddPos0=new gt,this._lastAddPos1=new gt,this._currentTime=this._lastTime=0,this.setting=t,this.initialize(),this.loadShaderParams(),this.loadContent(),this.scLeft=new N,this.scRight=new N}r(t,"laya.d3.resource.tempelet.GlitterTemplet");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRender":!0}),e.getBakedVertexs=function(t){return void 0===t&&(t=0),null},e.getBakedIndices=function(){return null},e.getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e.getIndexBuffer=function(){return null},e.initialize=function(){this._vertices=new Float32Array(this.setting.maxSegments*this._floatCountPerVertex*2)},e.loadContent=function(){this._vertexBuffer=new Ft(Z.vertexDeclaration,2*this.setting.maxSegments,35048)},e.loadShaderParams=function(){if(this._sharderNameID=C.nameKey.get("GLITTER"),this.setting.texturePath){this._shaderValue.pushValue("DIFFUSETEXTURE",null,-1);var t=this;i.loader.load(this.setting.texturePath,c.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,t.texture=e}))}},e.update=function(t){this._currentTime+=t/1e3,this.retireActiveGlitters(),this.freeRetiredGlitters(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this.updateTextureCoordinate()},e._render=function(t){if(this.texture&&this.texture.loaded){if(this.update(t.elapsedTime),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._firstActiveElement!=this._firstFreeElement){w.mainContext;this._vertexBuffer.bind(null),this._shader=this.getShader(t);var e=this._shaderValue.length;this._shaderValue.pushArray(t.shaderValue),this._shaderValue.pushArray(this._vertexBuffer.vertexDeclaration.shaderValues),this._shaderValue.pushValue("UNICOLOR",this.setting.color.elements,-1),this._shaderValue.pushValue("MVPMATRIX",t.projectionViewMatrix.elements,-1),this._shaderValue.pushValue("DURATION",this.setting.lifeTime,-1),this._shaderValue.pushValue("LUMINANCE",1,-1),this._shaderValue.pushValue("CURRENTTIME",this._currentTime,-1),this._shaderValue.data[1][0]=this.texture.source,this._shaderValue.data[1][1]=this.texture.bitmap.id,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=e,this._firstActiveElement<this._firstFreeElement?w.mainContext.drawArrays(5,2*this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(w.mainContext.drawArrays(5,2*this._firstActiveElement,2*(this.setting.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&w.mainContext.drawArrays(5,0,2*this._firstFreeElement)),A.drawCall++}this._drawCounter++}return!0},e.addVertexPositionVelocity=function(t,e,i,n){if(0===this.numPositionVelocityMode)this.numPositionVelocityMode++;else{var r=new gt;gt.subtract(t,this.posVelModePosition0,r);var a=gt.scalarLength(r);gt.subtract(i,this.posVelModePosition1,r);var s=gt.scalarLength(r),o=0;if(a<this.setting.minSegmentDistance&&s<this.setting.minSegmentDistance)return;if(o=1+Math.floor(Math.max(a,s)/this.setting.minInterpDistance),1===o)this.addGlitter(t,i,this._currentTime);else{o=Math.min(o,this.setting.maxSlerpCount),this.scLeft.Init(this.posVelModePosition0,this.posVelModeVelocity0,t,e),this.scRight.Init(this.posVelModePosition1,this.posVelModeVelocity1,i,n);for(var l=1/o,h=l,u=1;o>=u;u++){var _=this._tempVector0;this.scLeft.Slerp(h,_);var c=this._tempVector1;this.scRight.Slerp(h,c);var d=this._lastTime+(this._currentTime-this._lastTime)*u/o;this.addGlitter(_,c,d),h+=l}}}this._lastTime=this._currentTime,t.cloneTo(this.posVelModePosition0),e.cloneTo(this.posVelModeVelocity0),i.cloneTo(this.posVelModePosition1),n.cloneTo(this.posVelModeVelocity1)},e.addVertexPosition=function(t,e){if(this.numPositionMode<2)0===this.numPositionMode?(t.cloneTo(this.posModeLastPosition0),e.cloneTo(this.posModeLastPosition1)):(t.cloneTo(this.posModePosition0),e.cloneTo(this.posModePosition1)),this.numPositionMode++;else{var i=this._tempVector2;this.CalcVelocity(t,this.posModeLastPosition0,i);var n=this._tempVector3;this.CalcVelocity(e,this.posModeLastPosition1,n),this.addVertexPositionVelocity(this.posModePosition0,i,this.posModePosition1,n),this.posModePosition0.cloneTo(this.posModeLastPosition0),this.posModePosition1.cloneTo(this.posModeLastPosition1),t.cloneTo(this.posModePosition0),e.cloneTo(this.posModePosition1)}},e.addNewParticlesToVertexBuffer=function(){this._vertexBuffer.clear(),this._vertexBuffer.append(this._vertices);var t=0;this._firstActiveElement<this._firstFreeElement?(t=2*this._firstActiveElement*this._floatCountPerVertex*4,this._vertexBuffer.subUpload(t,t,t+2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex*4)):(t=2*this._firstActiveElement*this._floatCountPerVertex*4,this._vertexBuffer.subUpload(t,t,t+2*(this.setting.maxSegments-this._firstActiveElement)*this._floatCountPerVertex*4),this._firstFreeElement>0&&(this._vertexBuffer.setNeedUpload(),this._vertexBuffer.subUpload(0,0,2*this._firstFreeElement*this._floatCountPerVertex*4))),this._firstNewElement=this._firstFreeElement},e.updateTextureCoordinate=function(){this._firstActiveElement<this._firstFreeElement?this.updateTextureCoordinateData(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this.updateTextureCoordinateData(this._firstActiveElement,2*(this.setting.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this.updateTextureCoordinateData(0,2*this._firstFreeElement))},e.updateTextureCoordinateData=function(t,e){for(var i=0;e>i;i+=2){var n=(2*t+i+0)*this._floatCountPerVertex,r=(2*t+i+1)*this._floatCountPerVertex;this._vertices[n+3]=this._vertices[r+3]=(this._vertices[n+5]-this._currentTime)/this.setting.lifeTime}},e.retireActiveGlitters=function(){for(var t=this.setting.lifeTime;this._firstActiveElement!=this._firstNewElement;){var e=this._firstActiveElement*this._floatCountPerVertex*2+5,i=this._currentTime-this._vertices[e];if(t>i)break;this._vertices[e]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.setting.maxSegments&&(this._firstActiveElement=0)}},e.freeRetiredGlitters=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*2+5];if(3>t)break;this._firstRetiredElement++,this._firstRetiredElement>=this.setting.maxSegments&&(this._firstRetiredElement=0)}},e.addGlitter=function(t,e,i){this._needPatch&&(this._needPatch=!1,this.addGlitter(this._lastAddPos0,this._lastAddPos1,this._lastAddTime));var n=this._firstFreeElement+1;if(n>=this.setting.maxSegments&&(n=0,t.cloneTo(this._lastAddPos0),e.cloneTo(this._lastAddPos1),this._lastAddTime=i,this._needPatch=!0),n!==this._firstRetiredElement){var r=t.elements,a=e.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;3>s;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=i;var l=o+this._floatCountPerVertex;for(s=0;3>s;s++)this._vertices[l+s]=a[s];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=i,this._firstFreeElement=n}},e.CalcVelocity=function(t,e,i){gt.subtract(t,e,i),gt.scale(i,.5,i)},e.getShader=function(t){var e=t.shaderDefs,i=e._value,n=(e._value|t.shadingMode)+2e-4*this._sharderNameID;return this._shader=C.withCompile(this._sharderNameID,t.shadingMode,t.shaderDefs.toNameDic(),n,null),e._value=i,this._shader},a(0,e,"VertexBufferCount",function(){return 1}),a(0,e,"indexOfHost",function(){return 0}),t}(),Mt=function(){function t(t){this._ib=null,this._materialIndex=-1,this._elementCount=0,this._vbOffet=0,this._vb=null,this._meshTemplet=null,this._boneIndex=null,this._boneData=null,this._bufferUsage={},this._finalBufferUsageDic=null,this.verticesIndices=null,this._meshTemplet=t}r(t,"laya.d3.resource.tempelet.SubMeshTemplet");var e=t.prototype;return e._mergeRendering=function(t,e,i){},e._setVBOffset=function(t){this._vbOffet=t},e._setBoneDic=function(t){this._boneIndex=t,this._meshTemplet.disableUseFullBone(),this._boneData=new Float32Array(16*this._boneIndex.length)},e.getMaterial=function(t){return this._materialIndex>=0?t[this._materialIndex]:null},e.setIB=function(t,e){this._ib=t,this._elementCount=e},e.getIB=function(){return this._ib},e.setVB=function(t){this._vb=t},e.getVB=function(){return this._vb},a(0,e,"material",function(){return this._materialIndex},function(t){this._materialIndex=t}),t._copyBone=function(t,e,i){for(var n=0,r=t.length,a=0;r>n;n++)for(var s=0;16>s;s++,a++)i[a]=e[(t[n]<<4)+s]},t}(),Ct=function(){function t(){}return r(t,"laya.d3.shader.Shader3D"),t.__init__=function(){t.SIMPLE=C.nameKey.add("SIMPLE"),t.TERRAIN=C.nameKey.add("TERRAIN"),t.PARTICLE=C.nameKey.add("PARTICLE"),t.U3DPARTICLE=C.nameKey.add("U3DPARTICLE"),t.GLITTER=C.nameKey.add("GLITTER"),t.SIMPLE_EFFECT=C.nameKey.add("SIMPLE_EFFECT"),C.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Ambient;\n vec3 Specular;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec=-normalize(dirLight.Direction);\n	\n	amb=matAmb*dirLight.Ambient;\n	\n	float  diffuseFactor=dot(lightVec, normal);\n	\n	if(diffuseFactor>0.0)\n	{\n	   vec3 v = reflect(-lightVec, normal);\n	   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n	   \n	   dif = diffuseFactor * matDif * dirLight.Diffuse;\n	   spec = specFactor * matSpe.rgb * dirLight.Specular;\n	}\n	\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	dif=vec3(0.0);\n	amb=vec3(0.0);\n	spec=vec3(0.0);\n	vec3 lightVec = poiLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > poiLight.Range )\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * poiLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if( diffuseFactor > 0.0 )\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * poiLight.Diffuse;\n		spec = specFactor * matSpe.rgb * poiLight.Specular;\n	}\n\n	float attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n	amb = vec3(0.0);\n	dif =vec3(0.0);\n	spec= vec3(0.0);\n	vec3 lightVec = spoLight.Position - pos;\n		\n	float d = length(lightVec);\n	\n	if( d > spoLight.Range)\n		return;\n		\n	lightVec /= d; \n	\n	amb = matAmb * spoLight.Ambient;	\n\n	float diffuseFactor = dot(lightVec, normal);\n\n	if(diffuseFactor > 0.0)\n	{\n		vec3 v= reflect(-lightVec, normal);\n		float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n					\n		dif = diffuseFactor * matDif * spoLight.Diffuse;\n		spec = specFactor * matSpe.rgb * spoLight.Specular;\n	}\n	\n	float spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n	float attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n	amb *= spot;\n	dif *= attenuate;\n	spec*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n	vec3 normalT = 2.0*normalMapSample - 1.0;\n\n	// Build orthonormal basis.\n	vec3 N = normalize(unitNormal);\n	vec3 T = normalize( tangent- dot(tangent, N)*N);\n	vec3 B = cross(T, N);\n\n	mat3 TBN = mat3(T, B, N);\n\n	// Transform from tangent space to world space.\n	vec3 bumpedNormal = TBN*normalT;\n\n	return bumpedNormal;\n}\n"),
C.addInclude("VRHelper.glsl","\nvec4 DistortFishEye(vec4 p)\n{\n    vec2 v = p.xy / p.w;\n    float radius = length(v);// Convert to polar coords\n    if (radius > 0.0)\n    {\n      float theta = atan(v.y,v.x);\n      \n      radius = pow(radius, 0.93);// Distort:\n\n      v.x = radius * cos(theta);// Convert back to Cartesian\n      v.y = radius * sin(theta);\n      p.xy = v.xy * p.w;\n    }\n    return p;\n}");var e,i,n={a_Position:"POSITION",a_Color:"COLOR",a_Normal:"NORMAL",a_Texcoord0:"UV",a_Texcoord1:"UV1",a_TexcoordNext0:"NEXTUV",a_BoneWeights:"BLENDWEIGHT",a_BoneIndices:"BLENDINDICES",a_Tangent0:"TANGENT0",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_NormalTexture:"NORMALTEXTURE",u_AmbientTexture:"AMBIENTTEXTURE",u_ReflectTexture:"REFLECTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Bones:"MATRIXARRAY0",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Luminance:"LUMINANCE",u_AlphaTestValue:"ALPHATESTVALUE",u_UVMatrix:"MATRIX2",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX","u_DirectionLight.Direction":"LIGHTDIRECTION","u_DirectionLight.Diffuse":"LIGHTDIRDIFFUSE","u_DirectionLight.Ambient":"LIGHTDIRAMBIENT","u_DirectionLight.Specular":"LIGHTDIRSPECULAR","u_PointLight.Position":"POINTLIGHTPOS","u_PointLight.Range":"POINTLIGHTRANGE","u_PointLight.Attenuation":"POINTLIGHTATTENUATION","u_PointLight.Diffuse":"POINTLIGHTDIFFUSE","u_PointLight.Ambient":"POINTLIGHTAMBIENT","u_PointLight.Specular":"POINTLIGHTSPECULAR",u_MaterialDiffuse:"MATERIALDIFFUSE",u_MaterialAmbient:"MATERIALAMBIENT",u_MaterialSpecular:"MATERIALSPECULAR",u_MaterialReflect:"MATERIALREFLECT","u_SpotLight.Position":"SPOTLIGHTPOS","u_SpotLight.Direction":"SPOTLIGHTDIRECTION","u_SpotLight.Range":"SPOTLIGHTRANGE","u_SpotLight.Spot":"SPOTLIGHTSPOT","u_SpotLight.Attenuation":"SPOTLIGHTATTENUATION","u_SpotLight.Diffuse":"SPOTLIGHTDIFFUSE","u_SpotLight.Ambient":"SPOTLIGHTAMBIENT","u_SpotLight.Specular":"SPOTLIGHTSPECULAR"};e='#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#include?VR "VRHelper.glsl";\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM\n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_ToEye;\nvarying vec3 v_Normal;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n \n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  #ifdef BONE\n  vec3 normal=normalize( mat3(u_WorldMat*skinTransform)*a_Normal);\n  #else\n  vec3 normal=normalize( mat3(u_WorldMat)*a_Normal);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_Normal=normal;\n  #endif\n#endif\n \n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  v_Diffuse=vec3(0.0);\n  v_Ambient=vec3(0.0);\n  v_Specular=vec3(0.0);\n  vec3 dif, amb, spe;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  #ifdef BONE\n  vec3 positionWorld=(u_WorldMat*position).xyz;\n  #else\n  vec3 positionWorld=(u_WorldMat*a_Position).xyz;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nvec3 toEye;\n  #ifdef FOG\n  toEye=u_CameraPos-positionWorld;\n  v_ToEyeLength=length(toEye);\n  toEye/=v_ToEyeLength;\n  #else\n  toEye=normalize(u_CameraPos-positionWorld);\n  #endif\n \n  #ifdef REFLECTMAP\n  v_ToEye=toEye;\n  #endif\n#endif\n \n#ifdef DIRECTIONLIGHT\ncomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n \n#ifdef POINTLIGHT\ncomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\nComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,positionWorld,normal,toEye, dif, amb, spe);\nv_Diffuse+=dif;\nv_Ambient+=amb;\nv_Specular+=spe;\n#endif\n  \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&COLOR&&SPECULARMAP)\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nvarying vec3 v_Diffuse;\nvarying vec3 v_Ambient;\nvarying vec3 v_Specular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\nvarying float v_ToEyeLength;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n#ifdef REFLECTMAP\nvarying vec3 v_Normal;\nvarying vec3 v_ToEye;\n#endif\n\n\nvoid main()\n{\n #ifdef DIFFUSEMAP&&!COLOR\n gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n #endif \n \n #ifdef COLOR&&!DIFFUSEMAP\n gl_FragColor=v_Color;\n #endif \n \n #ifdef DIFFUSEMAP&&COLOR\n vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n gl_FragColor=texColor*v_Color;\n #endif\n \n #ifdef !DIFFUSEMAP&&!COLOR\n gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n #endif \n \n #ifdef AMBIENTMAP\n gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n #endif \n \n gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n #ifdef ALPHATEST\n   if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n #endif\n \n \n #ifdef REFLECTMAP\n vec3 normal=normalize(v_Normal);\n #endif 	\n\n  \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n   #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n   vec3 specular =v_Specular*texture2D(u_SpecularTexture,v_Texcoord0).rgb;\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+specular,gl_FragColor.a);\n   #else\n   gl_FragColor =vec4( gl_FragColor.rgb*(v_Ambient + v_Diffuse)+v_Specular,gl_FragColor.a);\n   #endif\n #endif\n \n #ifdef REFLECTMAP\n vec3 incident = -v_ToEye;\n vec3 reflectionVector = reflect(incident,v_Normal);\n vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n #endif\n \n #ifdef FOG\n float lerpFact=clamp((v_ToEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n #endif\n}\n\n",C.preCompile(t.SIMPLE,4096,e,i,n),e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef MIXUV\n  attribute vec2 a_TexcoordNext0;\n  uniform float  u_UVAge;\n  #endif\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord1;\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP)&&NORMALMAP\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef BONE\n mat4 skinTransform=mat4(0.0);\n skinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n skinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n skinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n skinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n vec4 position=skinTransform*a_Position;\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * position);\n   #else\n   gl_Position = u_MvpMatrix * position;\n   #endif\n #else\n   #ifdef VR\n   gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n   #else\n   gl_Position = u_MvpMatrix * a_Position;\n   #endif\n #endif\n \n\n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n mat3 worldMat;\n   #ifdef BONE\n   worldMat=mat3(u_WorldMat*skinTransform);\n   #else\n   worldMat=mat3(u_WorldMat);\n   #endif  \n v_Normal=worldMat*a_Normal;\n   #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n   v_Tangent0=worldMat*a_Tangent0;\n   #endif\n #endif\n \n #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG\n   #ifdef BONE\n   v_PositionWorld=(u_WorldMat*position).xyz;\n   #else\n   v_PositionWorld=(u_WorldMat*a_Position).xyz;\n   #endif\n #endif\n \n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  #endif\n  #ifdef UVTRANSFORM\n  v_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n  #endif\n#endif\n\n#ifdef AMBIENTMAP\nv_Texcoord1=a_Texcoord1;\n#endif\n\n  \n#ifdef COLOR\nv_Color=a_Color;\n#endif\n}',i='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include?DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT "LightHelper.glsl";\n\nuniform float u_Luminance;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#ifdef DIFFUSEMAP||((DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&(COLOR&&SPECULARMAP||NORMALMAP))\nvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef AMBIENTMAP\nvarying vec2 v_Texcoord1;\nuniform sampler2D u_AmbientTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||AMBIENTMAP\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef MIXUV\nuniform float  u_UVAniAge;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\nvarying vec3 v_Normal;\n#endif\n\n#ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\n\n#ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef !DIFFUSEMAP&&!COLOR\n  gl_FragColor=vec4(1.0,1.0,1.0,1.0);\n  #endif \n  \n  #ifdef AMBIENTMAP\n  gl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_Texcoord1).rgb);\n  #endif \n  \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef ALPHATEST\n  if(gl_FragColor.a-u_AlphaTestValue<0.0)\n    discard;\n  #endif\n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||REFLECTMAP\n  vec3 normal;\n    #ifdef (DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT)&&NORMALMAP\n    vec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n	normal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n	#else\n	normal = normalize(v_Normal);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n  vec3 diffuse = vec3(0.0);\n  vec3 ambient = vec3(0.0);\n  vec3 specular= vec3(0.0);\n  vec3 dif, amb, spe;\n  #endif\n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT||FOG||REFLECTMAP\n  vec3 toEye;\n    #ifdef FOG\n	toEye=u_CameraPos-v_PositionWorld;\n    float toEyeLength=length(toEye);\n    toEye/=toEyeLength;\n    #else\n	toEye=normalize(u_CameraPos-v_PositionWorld);\n    #endif\n  #endif\n	\n  #ifdef DIRECTIONLIGHT\n  computeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n \n  #ifdef POINTLIGHT\n  computePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n\n  #ifdef SPOTLIGHT\n  ComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,v_PositionWorld,normal,toEye, dif, amb, spe);\n  diffuse+=dif;\n  ambient+=amb;\n  specular+=spe;\n  #endif\n  \n\n  \n  \n  \n  #ifdef DIRECTIONLIGHT||POINTLIGHT||SPOTLIGHT\n    #ifdef (DIFFUSEMAP||COLOR)&&SPECULARMAP\n    specular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n  gl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n  #endif\n  \n  #ifdef REFLECTMAP\n  vec3 incident = -toEye;\n  vec3 reflectionVector = reflect(incident,normal);\n  vec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n  gl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n  #endif\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n',C.preCompile(t.SIMPLE,8192,e,i,n),n={a_Position:"POSITION",a_Texcoord:"UV",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_WorldMat:"MATRIX1",u_CameraPos:"CAMERAPOS",u_BlendTexture:"DIFFUSETEXTURE",u_LayerTexture0:"NORMALTEXTURE",u_LayerTexture1:"SPECULARTEXTURE",u_LayerTexture2:"EMISSIVETEXTURE",u_LayerTexture3:"AMBIENTTEXTURE",u_MvpMatrix:"MVPMATRIX",u_Luminance:"LUMINANCE",u_Ambient:"MATERIALAMBIENT",u_UVMatrix:"MATRIX2"},e='#include?VR "VRHelper.glsl";\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_UVMatrix;\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\nattribute vec2 a_Texcoord;\nvarying vec2 v_Texcoord;\nvarying vec2 v_TiledTexcoord;\n#endif\n\n#ifdef FOG\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\n\nvoid main()\n{\n #ifdef VR\n gl_Position = DistortFishEye(u_MvpMatrix * a_Position);\n #else\n gl_Position = u_MvpMatrix * a_Position;\n #endif\n \n #ifdef FOG\n v_PositionWorld=(u_WorldMat*a_Position).xyz;\n #endif\n \n #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n v_Texcoord=a_Texcoord;\n v_TiledTexcoord=(u_UVMatrix*vec4(a_Texcoord,0.0,1.0)).xy;\n #endif\n}',i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\nuniform vec3 u_Ambient;\n\n#ifdef FOG\nuniform vec3 u_CameraPos;\nvarying vec3 v_PositionWorld;\n\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\n#ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  varying vec2 v_Texcoord;\n  varying vec2 v_TiledTexcoord;\n  uniform sampler2D u_BlendTexture;\n  uniform sampler2D u_LayerTexture0;\n  uniform sampler2D u_LayerTexture1;\n  uniform sampler2D u_LayerTexture2;\n  uniform sampler2D u_LayerTexture3;\n#endif\n\nvoid main()\n{	\n  #ifdef DIFFUSEMAP&&NORMALMAP&&SPECULARMAP&&EMISSIVEMAP&&AMBIENTMAP\n  vec4 blend=texture2D(u_BlendTexture, v_Texcoord);\n  vec4 c0=texture2D(u_LayerTexture0, v_TiledTexcoord);\n  vec4 c1=texture2D(u_LayerTexture1, v_TiledTexcoord);\n  vec4 c2=texture2D(u_LayerTexture2, v_TiledTexcoord);\n  vec4 c3=texture2D(u_LayerTexture3, v_TiledTexcoord);\n  vec4 texColor = c0;\n  texColor = mix(texColor, c1, blend.r);\n  texColor = mix(texColor, c2, blend.g);\n  texColor = mix(texColor, c3, blend.b);\n  gl_FragColor=vec4(texColor.rgb*u_Ambient.rgb*blend.a*u_Luminance,1.0);\n  #endif \n  \n  #ifdef FOG\n  vec3 toEye=u_CameraPos-v_PositionWorld;\n  float toEyeLength=length(toEye);\n  \n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",C.preCompile(t.TERRAIN,4096,e,i,n),C.preCompile(t.TERRAIN,8192,e,i,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"},C.preCompile(t.PARTICLE,4096,v.vs,v.ps,n),C.preCompile(t.PARTICLE,8192,v.vs,v.ps,n),n={a_CornerTextureCoordinate:"CORNERTEXTURECOORDINATE",a_Position:"POSITION",a_Velocity:"VELOCITY",a_StartColor:"STARTCOLOR",a_EndColor:"ENDCOLOR",a_SizeRotation:"SIZEROTATION",a_Radius:"RADIUS",a_Radian:"RADIAN",a_AgeAddScale:"AGEADDSCALE",a_Time:"TIME",u_WorldMat:"MVPMATRIX",u_View:"MATRIX1",u_Projection:"MATRIX2",u_ViewportScale:"VIEWPORTSCALE",u_CurrentTime:"CURRENTTIME",u_Duration:"DURATION",u_Gravity:"GRAVITY",u_EndVelocity:"ENDVELOCITY",u_texture:"DIFFUSETEXTURE"},C.preCompile(t.U3DPARTICLE,4096,v.vs,v.ps,n),C.preCompile(t.U3DPARTICLE,8192,v.vs,v.ps,n),n={a_Position:"POSITION",a_Texcoord0:"UV",a_Time:"TIME",u_Texture:"DIFFUSETEXTURE",u_MvpMatrix:"MVPMATRIX",u_Luminance:"LUMINANCE",u_CurrentTime:"CURRENTTIME",u_Color:"UNICOLOR",u_Duration:"DURATION"},e="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{	\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n}\n\n",C.preCompile(t.GLITTER,4096,e,i,n),C.preCompile(t.GLITTER,8192,e,i,n),n={a_Position:"POSITION",a_Color:"COLOR",a_Texcoord0:"UV",a_TexcoordNext0:"NEXTUV",a_Texcoord1:"UV1",a_TexcoordNext1:"NEXTUV1",u_DiffuseTexture:"DIFFUSETEXTURE",u_SpecularTexture:"SPECULARTEXTURE",u_MvpMatrix:"MVPMATRIX",u_FogStart:"FOGSTART",u_FogRange:"FOGRANGE",u_FogColor:"FOGCOLOR",u_Luminance:"LUMINANCE",u_UVAge:"FLOAT0",u_UVAniAge:"UVAGEX"},e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",C.preCompile(t.SIMPLE_EFFECT,4096,e,i,n),e="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#ifdef DIFFUSEMAP\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n#ifdef MIXUV\nattribute vec2 a_TexcoordNext0;\nattribute vec2 a_TexcoordNext1;\nuniform float  u_UVAge;\n#endif\n#endif\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n\nvoid main()\n{\n gl_Position = u_MvpMatrix * a_Position;\n \n \n #ifdef DIFFUSEMAP\n  #ifdef MIXUV\n  v_Texcoord0=mix(a_Texcoord0,a_TexcoordNext0,u_UVAge);\n   v_Texcoord1=mix(a_Texcoord1,a_TexcoordNext1,u_UVAge);\n  #else\n  v_Texcoord0=a_Texcoord0;\n  v_Texcoord1=a_Texcoord1;\n  #endif\n #endif\n  \n #ifdef COLOR\n v_Color=a_Color;\n #endif\n}",i="#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Luminance;\n\n#ifdef DIFFUSEMAP\nvarying vec2 v_Texcoord0;\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef SPECULARMAP \nvarying vec2 v_Texcoord1;\nuniform sampler2D u_SpecularTexture;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n\n\n#ifdef FOG\nuniform float u_FogStart;\nuniform float u_FogRange;\nuniform vec3 u_FogColor;\n#endif\n\nvoid main()\n{\n  \n  #ifdef DIFFUSEMAP&&!COLOR\n  gl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  #endif \n  \n  #ifdef COLOR&&!DIFFUSEMAP\n  gl_FragColor=v_Color;\n  #endif \n  \n  #ifdef DIFFUSEMAP&&COLOR\n  vec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n  gl_FragColor=texColor*v_Color;\n  #endif\n  \n  #ifdef SPECULARMAP \n  vec4 specularColor=texture2D(u_SpecularTexture, v_Texcoord1);\n  gl_FragColor=gl_FragColor*specularColor;\n  #endif\n \n  gl_FragColor.rgb=gl_FragColor.rgb*u_Luminance;\n  \n  #ifdef FOG\n  float lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n  gl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n  #endif\n}\n\n",C.preCompile(t.SIMPLE_EFFECT,8192,e,i,n)},t.SIMPLE=0,t.TERRAIN=0,t.PARTICLE=0,t.U3DPARTICLE=0,t.GLITTER=0,t.SIMPLE_EFFECT=0,t}(),Dt=(function(){function t(){}return r(t,"laya.d3.utils.Picker"),t.CalculateCursorRay=function(t,e,i,n,r){var a=t.elements[0],s=t.elements[1],o=new gt(a,s,e.minDepth),l=new gt(a,s,e.maxDepth),h=e.unprojectFromWVP(o,i,n,r),u=e.unprojectFromWVP(l,i,n,r),_=new gt(u.x-h.x,u.y-h.y,u.z-h.z);return gt.normalize(_,_),new pt(h,_)},t.RayIntersectsTriangle=function(t,e,i,n){var r,a=new gt,s=new gt;gt.subtract(i,e,a),gt.subtract(n,e,s);var o=new gt;gt.cross(t.direction,s,o);var l;if(l=gt.dot(a,o),l>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return r=Number.NaN;var h=1/l,u=new gt;gt.subtract(t.origin,e,u);var _;if(_=gt.dot(u,o),_*=h,0>_||_>1)return r=Number.NaN;var c=new gt;gt.cross(u,a,c);var d;if(d=gt.dot(t.direction,c),d*=h,0>d||_+d>1)return r=Number.NaN;var f;return f=gt.dot(s,c),f*=h,r=0>f?Number.NaN:f},t}(),function(){function t(){}return r(t,"laya.d3.utils.Utils3D"),t._getTexturePath=function(t){var e=t.length-4;return t.indexOf(".dds")!=e&&t.indexOf(".tga")!=e&&t.indexOf(".exr")!=e&&t.indexOf(".DDS")!=e&&t.indexOf(".TGA")!=e&&t.indexOf(".EXR")!=e||(t=t.substr(0,e)+".png"),t=V.formatURL(t)},t.GenerateTangent=function(e,i,n,r,a){for(var s=3,o=i+s,l=new Float32Array(o*(e.length/i)),h=0;h<a.length;h+=3){var u=a[h+0],_=a[h+1],c=a[h+2],d=i*u+n,f=t._tempVector3_0;f.x=e[d+0],f.y=e[d+1],f.z=e[d+2];var m=i*_+n,p=t._tempVector3_1;p.x=e[m+0],p.y=e[m+1],p.z=e[m+2];var v=i*c+n,g=t._tempVector3_2;g.x=e[v+0],g.y=e[v+1],g.z=e[v+2];var T=i*u+r,x=e[T+0],I=e[T+1],M=i*_+r,C=e[M+0],D=e[M+1],E=i*c+r,A=e[E+0],y=e[E+1],V=t._tempVector3_3;gt.subtract(p,f,V);var b=t._tempVector3_4;gt.subtract(g,f,b),gt.scale(V,y-I,V),gt.scale(b,D-I,b);var P=t._tempVector3_5;gt.subtract(V,b,P),gt.scale(P,1/((C-x)*(y-I)-(D-I)*(A-x)),P);var w=0;for(w=0;i>w;w++)l[o*u+w]=e[i*u+w];for(w=0;s>w;w++)l[o*u+i+w]=+P.elements[w];for(w=0;i>w;w++)l[o*_+w]=e[i*_+w];for(w=0;s>w;w++)l[o*_+i+w]=+P.elements[w];for(w=0;i>w;w++)l[o*c+w]=e[i*c+w];for(w=0;s>w;w++)l[o*c+i+w]=+P.elements[w]}for(h=0;h<l.length;h+=o){var L=o*h+i,S=t._tempVector3_6;S.x=l[L+0],S.y=l[L+1],S.z=l[L+2],gt.normalize(S,S),l[L+0]=S.x,l[L+1]=S.y,l[L+2]=S.z}return l},t.getVertexTangentDeclaration=function(t){for(var e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=0;o<t.length;o++)switch(t[o].elementUsage){case"POSITION":e=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"BLENDWEIGHT":a=!0;break;case"BLENDINDICES":s=!0}var l;return e&&i&&n&&r&&a&&s?l=rt.vertexDeclaration:e&&i&&r&&a&&s?l=ut.vertexDeclaration:e&&i&&n&&a&&s?l=J.vertexDeclaration:e&&i&&n&&r?l=at.vertexDeclaration:e&&i&&r?l=_t.vertexDeclaration:e&&i&&n&&(l=$.vertexDeclaration),l},t._parseHierarchy=function(t,e,i){switch(e){case"translate":t.transform.localPosition=new gt(i[0],i[1],i[2]);break;case"rotation":t.transform.localRotation=new mt(i[0],i[1],i[2],i[3]);break;case"scale":t.transform.localScale=new gt(i[0],i[1],i[2])}},t._parseMaterial=function(e,n,r){switch(n){case"ambientColor":e.ambientColor=new gt(r[0],r[1],r[2]);break;case"diffuseColor":e.diffuseColor=new gt(r[0],r[1],r[2]);break;case"specularColor":e.specularColor=new Tt(r[0],r[1],r[2],r[3]);break;case"reflectColor":e.reflectColor=new gt(r[0],r[1],r[2]);break;case"diffuseTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.diffuseTexture=t}));break;case"normalTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.normalTexture=t}));break;case"specularTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.specularTexture=t}));break;case"emissiveTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.emissiveTexture=t}));break;case"ambientTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.ambientTexture=t}));break;case"reflectTexture":r.texture2D&&i.loader.load(t._getTexturePath(r.texture2D),c.create(null,function(t){t.bitmap.enableMerageInAtlas=!1,t.bitmap.mipmap=!0,e.reflectTexture=t}))}},t._computeSkinAnimationData=function(t,e,i,n,r){var a,s,o=0,l=0,h=i.length/2,u=t.length;for(a=0;u>a;o+=t[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D.rotationTransformScale(e[o+7],e[o+8],e[o+9],e[o+3],e[o+4],e[o+5],e[o+6],e[o+0],e[o+1],e[o+2],n,l),0!=a&&(s=16*t[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,s,n,l,n,l));for(a=0;h>a;a+=16)laya.d3.utils.Utils3D.mulMatrixByArrayFast(n,a,i,h+a,r,a)},t.mulMatrixByArray=function(e,i,n,r,a,s){var o,l,h,u,_;if(a===n){for(n=t._tempArray16_3,o=0;16>o;++o)n[o]=a[s+o];r=0}for(o=0;4>o;o++)l=e[i+o],h=e[i+o+4],u=e[i+o+8],_=e[i+o+12],a[s+o]=l*n[r+0]+h*n[r+1]+u*n[r+2]+_*n[r+3],a[s+o+4]=l*n[r+4]+h*n[r+5]+u*n[r+6]+_*n[r+7],a[s+o+8]=l*n[r+8]+h*n[r+9]+u*n[r+10]+_*n[r+11],a[s+o+12]=l*n[r+12]+h*n[r+13]+u*n[r+14]+_*n[r+15]},t.mulMatrixByArrayFast=function(t,e,i,n,r,a){var s,o,l,h,u;for(s=0;4>s;s++)o=t[e+s],l=t[e+s+4],h=t[e+s+8],u=t[e+s+12],r[a+s]=o*i[n+0]+l*i[n+1]+h*i[n+2]+u*i[n+3],r[a+s+4]=o*i[n+4]+l*i[n+5]+h*i[n+6]+u*i[n+7],r[a+s+8]=o*i[n+8]+l*i[n+9]+h*i[n+10]+u*i[n+11],r[a+s+12]=o*i[n+12]+l*i[n+13]+h*i[n+14]+u*i[n+15]},t.rotationTransformScale=function(e,i,n,r,a,s,o,l,h,u,_,c){var d=t._tempArray16_0,f=t._tempArray16_1,m=t._tempArray16_2,p=r+r,v=a+a,g=s+s,T=r*p,x=a*p,I=a*v,M=s*p,C=s*v,D=s*g,E=o*p,A=o*v,y=o*g;d[15]=1,d[0]=1-I-D,d[1]=x+y,d[2]=M-A,d[4]=x-y,d[5]=1-T-D,d[6]=C+E,d[8]=M+A,d[9]=C-E,d[10]=1-T-I,f[15]=1,f[0]=l,f[5]=h,f[10]=u;var V,b,P,w,L;for(V=0;4>V;V++)b=d[V],P=d[V+4],w=d[V+8],L=d[V+12],m[V]=b,m[V+4]=P,m[V+8]=w,m[V+12]=b*e+P*i+w*n+L;for(V=0;4>V;V++)b=m[V],P=m[V+4],w=m[V+8],L=m[V+12],_[V+c]=b*f[0]+P*f[1]+w*f[2]+L*f[3],_[V+c+4]=b*f[4]+P*f[5]+w*f[6]+L*f[7],_[V+c+8]=b*f[8]+P*f[9]+w*f[10]+L*f[11],_[V+c+12]=b*f[12]+P*f[13]+w*f[14]+L*f[15]},t.transformVector3ArrayToVector3ArrayCoordinate=function(e,i,n,r,a){var s=t._tempArray4_0,o=e[i+0],l=e[i+1],h=e[i+2],u=n.elements;s[0]=o*u[0]+l*u[4]+h*u[8]+u[12],s[1]=o*u[1]+l*u[5]+h*u[9]+u[13],s[2]=o*u[2]+l*u[6]+h*u[10]+u[14],s[3]=1/(o*u[3]+l*u[7]+h*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},t._tempVector3_0=new gt,t._tempVector3_1=new gt,t._tempVector3_2=new gt,
t._tempVector3_3=new gt,t._tempVector3_4=new gt,t._tempVector3_5=new gt,t._tempVector3_6=new gt,t._tempArray4_0=new Float32Array(4),t._tempArray16_0=new Float32Array(16),t._tempArray16_1=new Float32Array(16),t._tempArray16_2=new Float32Array(16),t._tempArray16_3=new Float32Array(16),n(t,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}}]),t}()),Et=function(t){function e(){this._id=0,this._cachedOwnerLayerMask=0,this._cachedOwnerEnable=!1,this._enable=!1,this._owner=null,this.started=!1,e.__super.call(this),this._id=e._uniqueIDCounter,e._uniqueIDCounter++}r(e,"laya.d3.component.Component3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0}),n._onLayerChanged=function(t){this._cachedOwnerLayerMask=t},n._onEnableChanged=function(t){this._cachedOwnerEnable=t},n._initialize=function(t){this._owner=t,this.enable=!0,this.started=!1,this._cachedOwnerLayerMask=t.layer.mask,this._owner.on("layerchanged",this,this._onLayerChanged),this._cachedOwnerEnable=t.enable,this._owner.on("enabledchanged",this,this._onEnableChanged),this._load(t)},n._uninitialize=function(){this._unload(this.owner),this._owner.off("layerchanged",this,this._onLayerChanged),this._owner.off("enabledchanged",this,this._onEnableChanged),this._owner=null},n._load=function(t){},n._start=function(t){},n._update=function(t){},n._lateUpdate=function(t){},n._preRenderUpdate=function(t){},n._postRenderUpdate=function(t){},n._unload=function(t){},a(0,n,"id",function(){return this._id}),a(0,n,"owner",function(){return this._owner}),a(0,n,"enable",function(){return this._enable},function(t){this._enable!==t&&(this._enable=t,this.event("enabledchanged",this._enable))}),a(0,n,"isActive",function(){return U.isActive(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),a(0,n,"isVisible",function(){return U.isVisible(this._cachedOwnerLayerMask)&&this._cachedOwnerEnable&&this._enable}),e.__init__=function(){},e._uniqueIDCounter=1,e}(_),At=function(t){function e(){this._texturesloaded=!1,this._shader=null,this._sharderNameID=0,this._disableDefine=0,this._color=[],this._transparent=!1,this._transparentMode=0,this._alphaTestValue=.5,this._luminance=1,this._transformUV=null,this._shaderDef=0,this._id=0,this.name=null,this.cullFace=!0,this.transparentAddtive=!1,this.loaded=!1,e.__super.call(this),this._textures=[],this._texturesSharderIndex=[],this._otherSharderIndex=[],this._shaderValues=new b,this._id=++e._uniqueIDCounter,this._color[0]=e.AMBIENTCOLORVALUE,this._color[1]=e.DIFFUSECOLORVALUE,this._color[2]=e.SPECULARCOLORVALUE,this._color[3]=e.REFLECTCOLORVALUE,this._pushShaderValue(0,"MATERIALAMBIENT",this._color[0].elements,this._id),this._pushShaderValue(1,"MATERIALDIFFUSE",this._color[1].elements,this._id),this._pushShaderValue(2,"MATERIALSPECULAR",this._color[2].elements,this._id),this._pushShaderValue(3,"MATERIALREFLECT",this._color[3].elements,this._id),this._pushShaderValue(5,"LUMINANCE",this._luminance,this._id),this.alphaTestValue=this._alphaTestValue}r(e,"laya.d3.core.material.Material",t);var i=e.prototype;return i._pushShaderValue=function(t,e,i,n){var r=this._shaderValues,a=this._otherSharderIndex[t];return a||(a=r.length+1,r.pushValue(e,null,-1),this._otherSharderIndex[t]=a),r.data[a][0]=i,r.data[a][1]=n,a},i._getShaderDefineValue=function(){return this._shaderDef=0,this.diffuseTexture&&(this._shaderDef|=1),this.normalTexture&&(this._shaderDef|=2),this.specularTexture&&(this._shaderDef|=4),this.emissiveTexture&&(this._shaderDef|=8),this.ambientTexture&&(this._shaderDef|=16),this.reflectTexture&&(this._shaderDef|=262144),this._transformUV&&(this._shaderDef|=16384),this._transparent&&0===this._transparentMode&&(this._shaderDef|=2048),this._shaderDef},i._setTexture=function(t,e,i){var n=this._texturesSharderIndex[e];return!n&&t&&(n=this._shaderValues.length+1,this._shaderValues.pushValue(i,null,-1),this._texturesSharderIndex[e]=n),t&&(this._texturesloaded=!1),this._textures[e]=t,n},i._loadeCompleted=function(){return this._texturesloaded?!0:this.diffuseTexture&&!this.diffuseTexture.loaded?!1:this.normalTexture&&!this.normalTexture.loaded?!1:this.specularTexture&&!this.specularTexture.loaded?!1:this.emissiveTexture&&!this.emissiveTexture.loaded?!1:this.ambientTexture&&!this.ambientTexture.loaded?!1:this.reflectTexture&&!this.reflectTexture.loaded?!1:(this.diffuseTexture&&this._uploadTexture(0,this.diffuseTexture),this.normalTexture&&this._uploadTexture(1,this.normalTexture),this.specularTexture&&this._uploadTexture(2,this.specularTexture),this.emissiveTexture&&this._uploadTexture(3,this.emissiveTexture),this.ambientTexture&&this._uploadTexture(4,this.ambientTexture),this.reflectTexture&&this._uploadTexture(5,this.reflectTexture),this._texturesloaded=!0)},i._uploadTexture=function(t,e){var i=this._shaderValues,n=i.data[this._texturesSharderIndex[t]];n[0]=e.source,n[1]=e.bitmap.id},i.getTextureByIndex=function(t){return this._textures[t]},i.getShader=function(t){var e=t.shaderDefs,i=e._value;this._disableDefine&&(e._value=i&~this._disableDefine);var n=(e._value|t.shadingMode)+2e-4*this._sharderNameID;return this._shader=C.withCompile(this._sharderNameID,t.shadingMode,e.toNameDic(),n,null),e._value=i,this._shader},i.upload=function(t,e,i){if(!this._loadeCompleted())return!1;i||(i=this.getShader(t));var n=this._shaderValues,r=n.length;return n.pushArray(t.shaderValue),i.tag._uploadMaterialID!=A.loopCount&&(i.tag._uploadMaterialID=A.loopCount,n.pushArray(t.worldShaderValue)),i.uploadArray(n.data,n.length,e),n.length=r,!0},i.disableLight=function(){this._disableDefine|=448},i.disableDefine=function(t){this._disableDefine=t},i.setShaderName=function(t){this._sharderNameID=C.nameKey.get(t)},i.copy=function(t){return t._sharderNameID=this._sharderNameID,t._shader=this._shader,t._texturesloaded=this._texturesloaded,t._textures=this._textures,t._texturesSharderIndex=this._texturesSharderIndex,t._otherSharderIndex=this._otherSharderIndex,t._disableDefine=this._disableDefine,t._color=this._color,t._transparent=this._transparent,t._transparentMode=this._transparentMode,t._alphaTestValue=this._alphaTestValue,t.transparentAddtive=this.transparentAddtive,t.cullFace=this.cullFace,t._transformUV=this._transformUV,this._shaderValues.copyTo(t._shaderValues),t},a(0,i,"id",function(){return this._id}),a(0,i,"reflectTexture",function(){return this._textures[5]},function(t){this._setTexture(t,5,"REFLECTTEXTURE"),this._getShaderDefineValue()}),a(0,i,"specularTexture",function(){return this._textures[2]},function(t){this._setTexture(t,2,"SPECULARTEXTURE"),this._getShaderDefineValue()}),a(0,i,"shaderDef",function(){return this._shaderDef}),a(0,i,"transparent",function(){return this._transparent},function(t){this._transparent=t,this.alphaTestValue=this._alphaTestValue,this._getShaderDefineValue()}),a(0,i,"alphaTestValue",function(){return this._alphaTestValue},function(t){this._alphaTestValue=t,this._pushShaderValue(7,"ALPHATESTVALUE",this._transparent&&0===this._transparentMode?this._alphaTestValue:null,this._id)}),a(0,i,"transparentMode",function(){return this._transparentMode},function(t){this._transparentMode=t,this.alphaTestValue=this._alphaTestValue,this._getShaderDefineValue()}),a(0,i,"diffuseTexture",function(){return this._textures[0]},function(t){this._setTexture(t,0,"DIFFUSETEXTURE"),this._getShaderDefineValue()}),a(0,i,"luminance",null,function(t){this._luminance=t,this._pushShaderValue(5,"LUMINANCE",this._luminance,this._id)}),a(0,i,"normalTexture",function(){return this._textures[1]},function(t){this._setTexture(t,1,"NORMALTEXTURE"),this._getShaderDefineValue()}),a(0,i,"emissiveTexture",function(){return this._textures[3]},function(t){this._setTexture(t,3,"EMISSIVETEXTURE"),this._getShaderDefineValue()}),a(0,i,"ambientTexture",function(){return this._textures[4]},function(t){this._setTexture(t,4,"AMBIENTTEXTURE"),this._getShaderDefineValue()}),a(0,i,"texturesCount",function(){return this._textures.length}),a(0,i,"ambientColor",null,function(t){this._color[0]=t,this._pushShaderValue(0,"MATERIALAMBIENT",t.elements,this._id)}),a(0,i,"diffuseColor",null,function(t){this._color[1]=t,this._pushShaderValue(1,"MATERIALDIFFUSE",t.elements,this._id)}),a(0,i,"specularColor",null,function(t){this._color[2]=t,this._pushShaderValue(2,"MATERIALSPECULAR",t.elements,this._id)}),a(0,i,"reflectColor",null,function(t){this._color[3]=t,this._pushShaderValue(3,"MATERIALREFLECT",t.elements,this._id)}),a(0,i,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t;var e=this._transformUV.matrix;this._pushShaderValue(6,"MATRIX2",e.elements,this._id),this._getShaderDefineValue()}),e._uniqueIDCounter=1,e.DIFFUSETEXTURE=0,e.NORMALTEXTURE=1,e.SPECULARTEXTURE=2,e.EMISSIVETEXTURE=3,e.AMBIENTTEXTURE=4,e.REFLECTTEXTURE=5,e.AMBIENTCOLOR=0,e.DIFFUSECOLOR=1,e.SPECULARCOLOR=2,e.REFLECTCOLOR=3,e.TRANSPARENT=4,e.LUMINANCE=5,e.TRANSFORMUV=6,e.ALPHATESTVALUE=7,n(e,["AMBIENTCOLORVALUE",function(){return this.AMBIENTCOLORVALUE=new gt(.6,.6,.6)},"DIFFUSECOLORVALUE",function(){return this.DIFFUSECOLORVALUE=new gt(1,1,1)},"SPECULARCOLORVALUE",function(){return this.SPECULARCOLORVALUE=new Tt(1,1,1,8)},"REFLECTCOLORVALUE",function(){return this.REFLECTCOLORVALUE=new gt(1,1,1)}]),e}(_),yt=(function(t){function e(){this._rotation=0,this._matNeedUpdte=!1,e.__super.call(this),this._tempTitlingV3=new gt,this._tempRotationMatrix=new ft,this._tempTitlingMatrix=new ft,this._matrix=new ft,this._offset=new vt,this._tiling=new vt}r(e,"laya.d3.core.TransformUV",t);var i=e.prototype;return i._updateMatrix=function(){this._tempTitlingV3.elements[0]=this._tiling.x,this._tempTitlingV3.elements[1]=this._tiling.y,this._tempTitlingV3.elements[2]=1,ft.createScaling(this._tempTitlingV3,this._tempTitlingMatrix),ft.createRotationZ(this._rotation,this._tempRotationMatrix),ft.multiply(this._tempRotationMatrix,this._tempTitlingMatrix,this._matrix);var t=this._matrix.elements;t[12]=this._offset.x,t[13]=this._offset.y,t[14]=0},a(0,i,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,i,"offset",function(){return this._offset},function(t){this._offset=t,this._matNeedUpdte=!0}),a(0,i,"rotation",function(){return this._rotation},function(t){this._rotation=t,this._matNeedUpdte=!0}),a(0,i,"tiling",function(){return this._tiling},function(t){this._tiling=t,this._matNeedUpdte=!0}),e}(_),function(t){function e(t){this._settings=null,this._particle3D=null,e.__super.call(this),this._resultPosition=new gt,this._resultVelocity=new gt,this.centerPosition=new gt,this.size=new gt,this.velocity=new gt,this.velocityAddVariance=new gt,this._particle3D=t;for(var i=t.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.boxEmitterCenterPosition[n],this.size.elements[n]=i.boxEmitterSize[n],this.velocity.elements[n]=i.boxEmitterVelocity[n],this.velocityAddVariance.elements[n]=i.boxEmitterVelocityAddVariance[n];this.emissionRate=i.emissionRate}r(e,"laya.d3.core.particle.EmitterBox",t);var i=e.prototype;return i._randomPositionOnBox=function(){var t=this._resultPosition.elements,e=this.centerPosition.elements,i=this.size.elements;return t[0]=e[0]+i[0]*(Math.random()-.5),t[1]=e[1]+i[1]*(Math.random()-.5),t[2]=e[2]+i[2]*(Math.random()-.5),this._resultPosition},i._randomVelocityOnBox=function(){var t=this._resultVelocity.elements,e=this.velocity.elements,i=this.velocityAddVariance.elements;return t[0]=e[0]+i[0]*Math.random(),t[1]=e[1]+i[1]*Math.random(),t[2]=e[2]+i[2]*Math.random(),this._resultVelocity},i.emit=function(){t.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnBox(),this._randomVelocityOnBox())},i.update=function(t){this.advanceTime(t.elapsedTime/1e3)},e}(u),function(t){function e(t){this._settings=null,this._particle3D=null,e.__super.call(this),this._resultPosition=new gt,this._resultVelocity=new gt,this.position=new gt,this.positionVariance=new gt,this.velocity=new gt,this.velocityAddVariance=new gt,this._particle3D=t;for(var i=t.templet.settings,n=0;3>n;n++)this.position.elements[n]=i.pointEmitterPosition[n],this.positionVariance.elements[n]=i.pointEmitterPositionVariance[n],this.velocity.elements[n]=i.pointEmitterVelocity[n],this.velocityAddVariance.elements[n]=i.pointEmitterVelocityAddVariance[n];this.emissionRate=i.emissionRate}r(e,"laya.d3.core.particle.EmitterPoint",t);var i=e.prototype;return i._randomPositionOnPoint=function(){var t=this._resultPosition.elements,e=this.position.elements,i=this.positionVariance.elements;return t[0]=e[0]+i[0]*(Math.random()-.5)*2,t[1]=e[1]+i[1]*(Math.random()-.5)*2,t[2]=e[2]+i[2]*(Math.random()-.5)*2,this._resultPosition},i._randomVelocityOnPoint=function(){var t=this._resultVelocity.elements,e=this.velocity.elements,i=this.velocityAddVariance.elements;return t[0]=e[0]+i[0]*Math.random(),t[1]=e[1]+i[1]*Math.random(),t[2]=e[2]+i[2]*Math.random(),this._resultVelocity},i.emit=function(){t.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnPoint(),this._randomVelocityOnPoint())},i.update=function(t){this.advanceTime(t.elapsedTime/1e3)},e}(u),function(t){function e(t){this._settings=null,this._particle3D=null,this.radius=30,this.velocity=0,this.velocityAddVariance=0,this.up=2,e.__super.call(this),this._resultPosition=new gt,this._resultVelocity=new gt,this._direction=new gt,this.centerPosition=new gt,this._particle3D=t;for(var i=t.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.ringEmitterCenterPosition[n];this.radius=i.ringEmitterRadius,this.velocity=i.ringEmitterVelocity,this.velocityAddVariance=i.ringEmitterVelocityAddVariance,this.emissionRate=i.emissionRate}r(e,"laya.d3.core.particle.EmitterRing",t);var i=e.prototype;return i._randomPointOnRing=function(){var t=Math.random()*Math.PI*2,e=Math.cos(t),i=Math.sin(t),n=this._resultPosition.elements,r=this.centerPosition.elements;switch(this.up){case 0:n[0]=r[0]+0,n[1]=r[1]+e*this.radius,n[2]=r[2]+i*this.radius;break;case 1:n[0]=r[0]+e*this.radius,n[1]=r[1]+0,n[2]=r[2]+i*this.radius;break;case 2:n[0]=r[0]+e*this.radius,n[1]=r[1]+i*this.radius,n[2]=r[2]+0}return this._resultPosition},i._randomVelocityOnRing=function(){var t=this._resultVelocity.elements;this._resultPosition.cloneTo(this._direction),gt.normalize(this._direction,this._direction);var e=this._direction.elements;return t[0]=e[0]*(this.velocity+this.velocityAddVariance*Math.random()),t[1]=e[1]*(this.velocity+this.velocityAddVariance*Math.random()),t[2]=e[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},i.emit=function(){t.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPointOnRing(),this._randomVelocityOnRing())},i.update=function(t){this.advanceTime(t/1e3)},e}(u),function(t){function e(t){this._settings=null,this._particle3D=null,this.radius=1,this.velocity=0,this.velocityAddVariance=0,e.__super.call(this),this._reultPosition=new gt,this._resultVelocity=new gt,this._direction=new gt,this.centerPosition=new gt,this._particle3D=t;for(var i=t.templet.settings,n=0;3>n;n++)this.centerPosition.elements[n]=i.sphereEmitterCenterPosition[n];this.radius=i.sphereEmitterRadius,this.velocity=i.sphereEmitterVelocity,this.velocityAddVariance=i.sphereEmitterVelocityAddVariance,this.emissionRate=i.emissionRate}r(e,"laya.d3.core.particle.EmitterSphere",t);var i=e.prototype;return i._randomPositionOnSphere=function(){var t=Math.random()*Math.PI*2,e=Math.random()*Math.PI*2,i=Math.cos(t)*this.radius,n=Math.sin(t)*this.radius,r=Math.cos(e)*i,a=Math.sin(e)*i,s=this._reultPosition.elements,o=this.centerPosition.elements;return s[0]=o[0]+r,s[1]=o[1]+n,s[2]=o[2]+a,this._reultPosition},i._randomVelocityOnSphere=function(){var t=this._resultVelocity.elements;this._reultPosition.cloneTo(this._direction),gt.normalize(this._direction,this._direction);var e=this._direction.elements;return t[0]=e[0]*(this.velocity+this.velocityAddVariance*Math.random()),t[1]=e[1]*(this.velocity+this.velocityAddVariance*Math.random()),t[2]=e[2]*(this.velocity+this.velocityAddVariance*Math.random()),this._resultVelocity},i.emit=function(){t.prototype.emit.call(this),this._particle3D.templet.addParticle(this._randomPositionOnSphere(),this._randomVelocityOnSphere())},i.update=function(t){this.advanceTime(t.elapsedTime/1e3)},e}(u),function(t){function e(t){this._loaded=!1,this._oriPosition=new gt,this._tempVector3=new gt,e.__super.call(this,t)}r(e,"laya.d3.core.fileModel.SkySubMesh",t);var i=e.prototype;return i._render=function(e){var i=e.owner.transform.position;this._loaded||(this._oriPosition.elements[0]=i.x,this._oriPosition.elements[1]=i.y,this._oriPosition.elements[2]=i.z,this._loaded=!0);var n=new ft;return e.viewMatrix.invert(n),this._tempVector3.elements[0]=this._oriPosition.x+n.elements[12],this._tempVector3.elements[1]=this._oriPosition.y+n.elements[13],this._tempVector3.elements[2]=this._oriPosition.z+n.elements[14],e.owner.transform.position=this._tempVector3,e.owner.transform.getWorldMatrix(-1),t.prototype._render.call(this,e)},e}(O)),Vt=(function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.glitter.SplineCurvePosition",t);var i=e.prototype;return i._CalcVelocity=function(t,e,i){gt.subtract(t,e,i),gt.scale(i,.5,i)},i.Init=function(e,i,n,r){this._CalcVelocity(i,e,this._tempVector30),this._CalcVelocity(r,n,this._tempVector31),t.prototype.Init.call(this,i,this._tempVector30,r,this._tempVector31)},e}(N),function(t){function e(){e.__super.call(this,e._name2int,e._int2name,e._int2nameMap)}return r(e,"laya.d3.shader.ShaderDefines3D",t),e.__init__=function(){e.reg("FSHIGHPRECISION",1048576),e.reg("DIFFUSEMAP",1),e.reg("NORMALMAP",2),e.reg("SPECULARMAP",4),e.reg("EMISSIVEMAP",8),e.reg("AMBIENTMAP",16),e.reg("REFLECTMAP",262144),e.reg("PARTICLE3D",32768),e.reg("COLOR",32),e.reg("VERTEXSHADERING",4096),e.reg("PIXELSHADERING",8192),e.reg("SKINNED",1024),e.reg("DIRECTIONLIGHT",64),e.reg("POINTLIGHT",128),e.reg("SPOTLIGHT",256),e.reg("BONE",512),e.reg("ALPHATEST",2048),e.reg("UVTRANSFORM",16384),e.reg("MIXUV",65536),e.reg("FOG",131072),e.reg("VR",524288)},e.reg=function(t,i){D._reg(t,i,e._name2int,e._int2name)},e.toText=function(t,e,i){return D._toText(t,e,i)},e.toInt=function(t){return D._toInt(t,e._name2int)},e.DIFFUSEMAP=1,e.NORMALMAP=2,e.SPECULARMAP=4,e.EMISSIVEMAP=8,e.AMBIENTMAP=16,e.REFLECTMAP=262144,e.VR=524288,e.FSHIGHPRECISION=1048576,e.UVTRANSFORM=16384,e.MIXUV=65536,e.FOG=131072,e.COLOR=32,e.DIRECTIONLIGHT=64,e.POINTLIGHT=128,e.SPOTLIGHT=256,e.BONE=512,e.SKINNED=1024,e.ALPHATEST=2048,e.PARTICLE3D=32768,e.VERTEXSHADERING=4096,e.PIXELSHADERING=8192,e._name2int={},e._int2name=[],e._int2nameMap=[],e}(D)),bt=function(t){function e(t){this._id=0,this._enable=!1,this._layerMask=0,this._componentsMap=[],this.transform=null,this.isStatic=!1,e.__super.call(this),this._components=[],this._wvpMatrix=new ft;var i=this;t?this.name=t:this.name="Sprite3D-"+e._nameNumberCounter++,this._enable=!0,this._id=e._uniqueIDCounter,e._uniqueIDCounter++,this.layer=U.currentCreationLayer,this.transform=new W(this),this.on("added",this,function(){i.transform._parent=i._parent.transform}),this.on("removed",this,function(){i.transform._parent=null})}r(e,"laya.d3.core.Sprite3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0}),n._updateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.isActive&&i._update(t)}},n._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.isActive&&i._lateUpdate(t)}},n._updateChilds=function(t){var e=this._childs.length;if(0!==e)for(var i=0;e>i;++i){var n=this._childs[i];n.active&&n._update(t)}},n._update=function(t){t.owner=this;var e=t.worldTransformModifyID;t.worldTransformModifyID+=this.transform._worldTransformModifyID,this.transform.getWorldMatrix(t.worldTransformModifyID),t.renderClip.view(this)&&(this._updateComponents(t),this._lateUpdateComponents(t)),this._childs.length&&this._updateChilds(t),t.worldTransformModifyID=e},n.addComponent=function(t){if(void 0!==this._componentsMap[t])throw new Error("无法创建"+t+"组件，"+t+"组件已存在！");var e=h.getInstance(t);return e._initialize(this),this._componentsMap[t]=this._components.length,this._components.push(e),this.event("componentadded",e),e},n.getComponentByType=function(t){return void 0===this._componentsMap[t]?null:this._components[this._componentsMap[t]]},n.getComponentByIndex=function(t){return this._components[t]},n.removeComponent=function(t){if(void 0!==this._componentsMap[t]){var e=this._components[this._componentsMap[t]];this._components.splice(this._componentsMap[t],1),delete this._componentsMap[t],this.event("componentremoved",e)}},n.removeAllComponent=function(){for(var t in this._componentsMap)this.removeComponent(t)},n.loadHierarchy=function(t){var e=this;if(null!==t){var i=new m,n=this;t=V.formatURL(t);var r=function(i){var r=V.basePath;V.basePath=V.getPath(V.formatURL(t)),e.addChild(h.createByJson(i,null,n,c.create(null,Dt._parseHierarchy,null,!1))),V.basePath=r,e.event("hierarchyloaded",n)};i.once("complete",null,r),i.load(t,"text")}},a(0,n,"id",function(){return this._id}),a(0,n,"enable",function(){return this._enable},function(t){this._enable=t,this.event("enabledchanged",this._enable)}),a(0,n,"wvpMatrix",function(){return this._wvpMatrix}),a(0,n,"active",function(){return U.isActive(this._layerMask)&&this._enable}),a(0,n,"visible",function(){return U.isVisible(this._layerMask)&&this._enable}),a(0,n,"layer",function(){return U.getLayerByMask(this._layerMask)},function(t){this._layerMask=t.mask,this.event("layerchanged",this._layerMask)}),a(0,n,"componentsCount",function(){return this._components.length}),a(0,n,"scene",function(){return this.parent.scene}),e._uniqueIDCounter=1,e._nameNumberCounter=0,e}(p),Pt=function(t){function e(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,e.__super.call(this)}r(e,"laya.d3.resource.tempelet.BaseMeshTemplet",t);var i=e.prototype;return i.Render=function(){throw new Error("未Override,请重载该方法！")},i.RenderSubMesh=function(t){throw new Error("未Override,请重载该方法！")},a(0,i,"subMeshCount",function(){return this._subMeshCount}),a(0,i,"boundingBox",function(){return this._boundingBox}),a(0,i,"boundingSphere",function(){return this._boundingSphere}),a(0,i,"positions",function(){throw new Error("未Override,请重载该属性！")}),e}(I),wt=(function(t){function e(t,i,n,r,a,s,o,l,h){this._alreadyResolved=!1,this._looked=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._mipMap=!1,this._repeat=!1,this._minFifter=0,this._magFifter=0,e.__super.call(this),void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),this._w=t,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this._createWebGLRenderTarget(),this.bitmap.lock=!0}r(e,"laya.d3.resource.RenderTarget",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDispose":!0}),n._createWebGLRenderTarget=function(){this.bitmap=new R(this.width,this.height,this._surfaceFormat,this._surfaceType,this._depthStencilFormat,this._mipMap,this._repeat,this._minFifter,this._magFifter),this.bitmap.activeResource(),this._alreadyResolved=!0},n.start=function(){var t=w.mainContext;t.bindFramebuffer(36160,this.bitmap.frameBuffer),e._currentRenderTarget=this,this._alreadyResolved=!1,e._currentRenderTarget=this},n.clear=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1);var r=w.mainContext;r.clearColor(t,e,i,n);var a=16384;switch(this._depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}r.clear(a)},n.end=function(){var t=w.mainContext;t.bindFramebuffer(36160,null),e._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(t,e,i,n){var r=w.mainContext;r.bindFramebuffer(36160,this.bitmap.frameBuffer);var a=36053===r.checkFramebufferStatus(36160);if(!a)return r.bindFramebuffer(36160,null),null;var s=new Uint8Array(this._w*this._h*4);return r.readPixels(t,e,i,n,this._surfaceFormat,this._surfaceType,s),r.bindFramebuffer(36160,null),s},n.dispose=function(){this.bitmap.dispose()},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"minFifter",function(){return this._minFifter}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"mipMap",function(){return this._mipMap}),a(0,n,"magFifter",function(){return this._magFifter}),a(0,n,"source",function(){if(this._alreadyResolved)return t.prototype._$get_source.call(this);throw new Error("RenderTarget  还未准备好！")}),e._currentRenderTarget=null,e}(y),function(t){function e(){this._url=null,this._templet=null,this.player=null,e.__super.call(this),this.player=new s}r(e,"laya.d3.component.animation.KeyframeAnimations",t);var i=e.prototype;return i.play=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=Number.MAX_VALUE),this.player.play(t,e,i)},i.stop=function(t){void 0===t&&(t=!0),this.player.stop(t)},a(0,i,"url",function(){return this._url},function(t){var e=this;0!==this.player.State&&this.player.stop(!0),this._url=V.formatURL(t);var i=I.animationCache[this._url],n=this;if(i)this._templet=i,this.player.templet=i;else{i=I.animationCache[this._url]=new f,this._templet=i,this.player.templet=i;var r=function(t){var n=t;i.parse(n,e.player.cacheFrameRate)},a=new m;a.once("complete",null,r),a.load(this._url,"arraybuffer")}i.loaded?this.event("loaded",this):i.once("loaded",null,function(t){n.event("loaded",n)})}),a(0,i,"currentFrameIndex",function(){return this.player.currentKeyframeIndex}),a(0,i,"NodeCount",function(){return this._templet.getNodeCount(this.player.currentAnimationClipIndex)}),a(0,i,"currentAnimationClipIndex",function(){return this.player.currentAnimationClipIndex}),a(0,i,"paused",function(){return this.player.paused},function(t){this.player.paused=t}),a(0,i,"cacheFrameRate",function(){return this.player.cacheFrameRate}),e}(Et)),Lt=(function(t){function e(){this._attachSkeleton=null,this._data=null,this._extenData=null,this.attachBone=null,this.matrix=null,e.__super.call(this)}r(e,"laya.d3.component.AttachPoint",t);var i=e.prototype;return i._load=function(e){t.prototype._load.call(this,e),this._attachSkeleton=e.getComponentByType(Gt)},i._update=function(e){if(this._attachSkeleton&&this._attachSkeleton._templet.loaded&&this.attachBone){var i=this._attachSkeleton._templet,n=i.getNodeIndexWithName.call(i,this._attachSkeleton.player.currentAnimationClipIndex,this.attachBone);this._data=this._attachSkeleton.curBonesDatas.subarray(16*n,16*(n+1)),this.matrix||(this.matrix=new ft),this.matrix.copyFromArray(this._data),t.prototype._update.call(this,e)}},e}(Et),function(t){function e(){e.__super.call(this)}return r(e,"laya.d3.component.Script",t),e}(Et),function(t){function e(t){this._vertexBuffer3D=null,this._indexBuffer3D=null,this._sharderNameID=0,this._shader=null,this._shaderValue=new b,e.__super.call(this,t),this.initialize(),this.loadShaderParams(),this._vertexBuffer=this._vertexBuffer3D=Ft.create(Y.vertexDeclaration,4*t.maxPartices,35048),this._indexBuffer=this._indexBuffer3D=Ut.create(6*t.maxPartices,35044),this.loadContent()}r(e,"laya.d3.resource.tempelet.ParticleTemplet3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IRender":!0}),n.getBakedVertexs=function(t){return void 0===t&&(t=0),null},n.getBakedIndices=function(){return null},n.getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer3D:null},n.getIndexBuffer=function(){return this._indexBuffer3D},n.loadShaderParams=function(){if(this._sharderNameID=C.nameKey.get("PARTICLE"),this.settings.textureName){this.texture=new y,this._shaderValue.pushValue("DIFFUSETEXTURE",null,-1);var t=this;i.loader.load(this.settings.textureName,c.create(null,function(e){e.bitmap.enableMerageInAtlas=!1,e.bitmap.mipmap=!0,t.texture=e}))}this._shaderValue.pushValue("DURATION",this.settings.duration,-1),this._shaderValue.pushValue("GRAVITY",this.settings.gravity,-1),this._shaderValue.pushValue("ENDVELOCITY",this.settings.endVelocity,-1)},n.addParticle=function(t,e){this.addParticleArray(t.elements,e.elements)},n._render=function(t){if(this.texture&&this.texture.loaded){if(this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._firstActiveElement!=this._firstFreeElement){w.mainContext;this._vertexBuffer3D.bind(this._indexBuffer3D),this._shader=this.getShader(t);var e=this._shaderValue.length;this._shaderValue.pushArray(t.shaderValue),this._shaderValue.pushArray(this._vertexBuffer3D.vertexDeclaration.shaderValues),this._shaderValue.pushValue("MVPMATRIX",t.owner.transform.getWorldMatrix(2).elements,-1),this._shaderValue.pushValue("MATRIX1",t.viewMatrix.elements,-1),this._shaderValue.pushValue("MATRIX2",t.projectionMatrix.elements,-1);var i=t.viewport.width/t.viewport.height,n=new vt(.5/i,-.5);this._shaderValue.pushValue("VIEWPORTSCALE",n.elements,-1),this._shaderValue.pushValue("CURRENTTIME",this._currentTime,-1),this._shaderValue.data[1][0]=this.texture.source,this._shaderValue.data[1][1]=this.texture.bitmap.id,this._shader.uploadArray(this._shaderValue.data,this._shaderValue.length,null),this._shaderValue.length=e;var r=0;this._firstActiveElement<this._firstFreeElement?(r=6*(this._firstFreeElement-this._firstActiveElement),w.mainContext.drawElements(4,r,5123,6*this._firstActiveElement*2),A.trianglesFaces+=r/3,A.drawCall++):(r=6*(this.settings.maxPartices-this._firstActiveElement),w.mainContext.drawElements(4,6*(this.settings.maxPartices-this._firstActiveElement),5123,6*this._firstActiveElement*2),A.trianglesFaces+=r/3,A.drawCall++,this._firstFreeElement>0&&(r=6*this._firstFreeElement,w.mainContext.drawElements(4,6*this._firstFreeElement,5123,0),A.trianglesFaces+=r/3,A.drawCall++))}return this._drawCounter++,!0}return!1},n.getShader=function(t){var e=t.shaderDefs,i=e._value;e.addInt(32768);var n=(e._value|t.shadingMode)+2e-4*this._sharderNameID;return this._shader=C.withCompile(this._sharderNameID,t.shadingMode,e.toNameDic(),n,null),e._value=i,this._shader},a(0,n,"VertexBufferCount",function(){return 1}),a(0,n,"indexOfHost",function(){return 0}),e}(g)),St=function(t){function e(){this._enableLightCount=3,this._renderTargetTexture=null,this._customRenderQueneIndex=11,this._lastCurrentTime=NaN,this.enableFog=!1,this.fogStart=NaN,this.fogRange=NaN,this.fogColor=null,this.enableLight=!0,this.currentCamera=null,e.__super.call(this),this._renderState=new k,this._lights=new Array,this._shadingMode=8192,this._renderConfigs=[],this._quenes=[],this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new gt(.7,.7,.7),this._renderConfigs[0]=new B,this._renderConfigs[0].depthTest=!1,this._renderConfigs[1]=new B,this._renderConfigs[2]=new B,this._renderConfigs[2].cullFace=!1,this._renderConfigs[4]=new B,this._renderConfigs[4].cullFace=!1,this._renderConfigs[4].blend=!0,this._renderConfigs[4].sFactor=770,this._renderConfigs[4].dFactor=771,this._renderConfigs[6]=new B,this._renderConfigs[6].cullFace=!1,this._renderConfigs[6].blend=!0,this._renderConfigs[6].sFactor=770,this._renderConfigs[6].dFactor=1,this._renderConfigs[3]=new B,this._renderConfigs[3].blend=!0,this._renderConfigs[3].sFactor=770,this._renderConfigs[3].dFactor=771,this._renderConfigs[5]=new B,this._renderConfigs[5].blend=!0,this._renderConfigs[5].sFactor=770,this._renderConfigs[5].dFactor=1,this._renderConfigs[8]=new B,this._renderConfigs[8].cullFace=!1,this._renderConfigs[8].blend=!0,this._renderConfigs[8].depthMask=0,this._renderConfigs[8].sFactor=770,this._renderConfigs[8].dFactor=771,this._renderConfigs[10]=new B,this._renderConfigs[10].cullFace=!1,this._renderConfigs[10].blend=!0,
this._renderConfigs[10].depthMask=0,this._renderConfigs[10].sFactor=770,this._renderConfigs[10].dFactor=1,this._renderConfigs[7]=new B,this._renderConfigs[7].blend=!0,this._renderConfigs[7].depthMask=0,this._renderConfigs[7].sFactor=770,this._renderConfigs[7].dFactor=771,this._renderConfigs[9]=new B,this._renderConfigs[9].blend=!0,this._renderConfigs[9].depthMask=0,this._renderConfigs[9].sFactor=770,this._renderConfigs[9].dFactor=1}r(e,"laya.d3.core.scene.BaseScene",t);var n=e.prototype;return i.imps(n,{"laya.webgl.submit.ISubmit":!0}),n._clearColor=function(t){var e=this.currentCamera.clearColor.elements;t.clearColor(e[0],e[1],e[2],e[3]),t.clear(16640)},n._prepareScene=function(t,e){U._currentCameraCullingMask=this.currentCamera.cullingMask,e.context=w.mainContext,e.worldTransformModifyID=1,e.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,e.reset(),e.loopCount=A.loopCount,e.shadingMode=this._shadingMode,e.scene=this,e.camera=this.currentCamera;for(var i=0;i<this._quenes.length;i++)this._quenes[i]&&this._quenes[i].reset();var n=e.worldShaderValue,r=A.loopCount;if(this.currentCamera&&n.pushValue("CAMERAPOS",this.currentCamera.transform.position.elements,r),this._lights.length>0){var a=0;for(i=0;i<this._lights.length;i++){var s=this._lights[i];if(s.active){if(a++,a>this._enableLightCount)break;s.updateToWorldState(e)}}}this.enableFog&&(e.worldShaderValue.pushValue("FOGSTART",this.fogStart,r),e.worldShaderValue.pushValue("FOGRANGE",this.fogRange,r),e.worldShaderValue.pushValue("FOGCOLOR",this.fogColor.elements,r))},n._updateScene=function(t){this._updateChilds(t)},n._updateChilds=function(t){for(var e=0,i=this._childs.length;i>e;++e){var n=this._childs[e];n.active&&n._update(t)}},n._renderScene=function(t,e){var i=e.viewport;t.viewport(i.x,k.clientHeight-i.y-i.height,i.width,i.height);for(var n=0;n<this._quenes.length;n++)this._quenes[n]&&(this._quenes[n]._setState(t),this._quenes[n]._render(e))},n._set3DRenderConfig=function(t){t.disable(3042),L._blend=!1,t.blendFunc(770,771),L._sFactor=770,L._dFactor=771,t.disable(2929),L._depthTest=!1,t.enable(2884),L._cullFace=!0,t.depthMask(1),L._depthMask=1,t.frontFace(2304),L._frontFace=2304},n._set2DRenderConfig=function(t){L.setBlend(t,!0),L.setBlendFunc(t,770,771),L.setDepthTest(t,!1),L.setCullFace(t,!0),L.setDepthMask(t,1),L.setFrontFaceCCW(t,2305),t.viewport(0,0,x.width,x.height)},n._addLight=function(t){this._lights.indexOf(t)<0&&this._lights.push(t)},n._removeLight=function(t){var e=this._lights.indexOf(t);e>=0&&this._lights.splice(e,1)},n.getRenderObject=function(t){return(this._quenes[t]||(this._quenes[t]=new H(this._renderConfigs[t]))).get()},n.addRenderQuene=function(t){this._quenes[this._customRenderQueneIndex++]=new H(t)},n.beforeUpate=function(t){},n.lateUpate=function(t){},n.beforeRender=function(t){},n.lateRender=function(t){},n.render=function(e,i,n){this._childs.length>0&&e.addRenderObject(this),this._renderType&=-2049,t.prototype.render.call(this,e,i,n)},n.renderSubmit=function(){return 1},n.getRenderType=function(){return 0},n.releaseRender=function(){},a(0,n,"scene",function(){return this}),a(0,n,"shadingMode",function(){return 4096==this._shadingMode?0:8192},function(t){if(0!==t&&1!==t)throw Error("Scene set shadingMode,must:0 or 1,value="+t);this._shadingMode=0===t?4096:8192}),e.VERTEX_SHADING=0,e.PIXEL_SHADING=1,e}(E),Rt=function(t){function e(t,i,n){this._isOrthographicProjection=!1,this._projectionMatrixModifyID=0,e.__super.call(this),this._tempVector3=new gt,this._up=new gt,this._forward=new gt,this._right=new gt,void 0===t&&(t=Math.PI/3),void 0===i&&(i=.1),void 0===n&&(n=1e3),this._fieldOfView=t,this._nearPlane=i,this._farPlane=n,this.cullingMask=2147483647,this.clearColor=new Tt(100/255,149/255,237/255,1),this._calculateProjectionMatrix()}r(e,"laya.d3.core.camera.BaseCamera",t);var i=e.prototype;return i._calculateProjectionMatrix=function(){},i.moveForward=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=t,this.transform.translate(this._tempVector3)},i.moveRight=function(t){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=t,this.transform.translate(this._tempVector3)},i.moveVertical=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=t,this.transform.translate(this._tempVector3,!1)},i.addLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask|t.mask)},i.removeLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask&~t.mask)},i.addAllLayers=function(){this.cullingMask=2147483647},i.removeAllLayers=function(){this.cullingMask=0|U.getLayerByNumber(29).mask|U.getLayerByNumber(30).mask},a(0,i,"fieldOfView",function(){return this._fieldOfView},function(t){this._fieldOfView=t,this._calculateProjectionMatrix()}),a(0,i,"forward",function(){var t=this.transform.worldMatrix.elements,e=this._forward.elements;return e[0]=-t[8],e[1]=-t[9],e[2]=-t[10],this._forward}),a(0,i,"nearPlane",function(){return this._nearPlane},function(t){this._nearPlane=t,this._calculateProjectionMatrix()}),a(0,i,"farPlane",function(){return this._farPlane},function(t){this._farPlane=t,this._calculateProjectionMatrix()}),a(0,i,"isOrthographicProjection",function(){return this._isOrthographicProjection}),a(0,i,"right",function(){var t=this.transform.worldMatrix.elements,e=this._right.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],this._right}),a(0,i,"up",function(){var t=this.transform.worldMatrix.elements,e=this._up.elements;return e[0]=t[4],e[1]=t[5],e[2]=t[6],this._up}),e}(bt),Ot=function(t){function e(){this._materials=null,this._templet=null,this._url=null,e.__super.call(this),this._subMeshes=new Array}r(e,"laya.d3.core.fileModel.Mesh",t);var i=e.prototype;return i._addSubMesh=function(t){return t._indexOfHost=this._subMeshes.length,t.mesh=this,this._subMeshes.push(t),this},i._updateToRenderQuene=function(t,e){var i=this._subMeshes;if(0!==i.length){e=e||this._templet.materials;for(var n=0,r=i.length;r>n;n++){var a=i[n],s=a.templet.getMaterial(e),o=this._addToRenderQuene(t,s);o.sortID=s.id,o.owner=this,o.renderElement=a,o.material=s,o.tag||(o.tag=new Object),o.tag.worldTransformModifyID=t.worldTransformModifyID}}},i._addToRenderQuene=function(t,e){var i;return!e.transparent||e.transparent&&0===e.transparentMode?i=e.cullFace?t.scene.getRenderObject(1):t.scene.getRenderObject(2):e.transparent&&1===e.transparentMode&&(i=e.transparentAddtive?e.cullFace?t.scene.getRenderObject(9):t.scene.getRenderObject(10):e.cullFace?t.scene.getRenderObject(7):t.scene.getRenderObject(8)),i},i._praseSubMeshTemplet=function(t){return new O(t)},i._update=function(t){t.owner=this;var e=t.worldTransformModifyID;t.worldTransformModifyID+=this.transform._worldTransformModifyID,this.transform.getWorldMatrix(t.worldTransformModifyID),this._templet&&t.renderClip.view(this)&&(this._updateComponents(t),this._updateToRenderQuene(t,this._materials),this._lateUpdateComponents(t),A.spriteCount++),this._childs.length&&this._updateChilds(t),t.worldTransformModifyID=e},i.load=function(t){var e=this;this._url=V.formatURL(t);var i=0,n=this,r=I.meshCache[this._url];if(r)this._templet=r,this._templet.loaded?this.event("loaded",this):this._templet.once("loaded",null,function(t){for(i=0;i<n._templet.subMeshes.length;i++)e._addSubMesh(e._praseSubMeshTemplet(n._templet.subMeshes[i]));n.event("loaded",n)});else{r=I.meshCache[this._url]=new Bt,this._templet=r;var a=new m;a.once("complete",null,function(t){for(new ct(t,n._templet,n._url),i=0;i<n._templet.subMeshes.length;i++)e._addSubMesh(e._praseSubMeshTemplet(n._templet.subMeshes[i]));n.event("loaded",n)}),a.load(this._url,"arraybuffer")}},a(0,i,"templet",function(){return this._templet}),a(0,i,"url",function(){return this._url}),a(0,i,"materials",function(){return this._materials},function(t){this._materials=t}),e}(bt),Nt=(function(t){function e(t){this._templet=null,e.__super.call(this),this._templet=new It(t)}r(e,"laya.d3.core.glitter.Glitter",t);var i=e.prototype;return i._update=function(t){t.owner=this;var e=t.worldTransformModifyID;t.worldTransformModifyID+=this.transform._worldTransformModifyID,this.transform.getWorldMatrix(t.worldTransformModifyID);var i=t.scene.getRenderObject(8);i.owner=t.owner=this,i.renderElement=this._templet,i.material=null,t.worldTransformModifyID=e,this._childs.length&&this._updateChilds(t)},a(0,i,"templet",function(){return this._templet}),e}(bt),function(t){function e(){this._diffuseColor=null,this._ambientColor=null,this._specularColor=null,this._reflectColor=null,e.__super.call(this),this.on("added",this,this._onAdded),this.on("removed",this,this._onRemoved),this._diffuseColor=new gt(.8,.8,.8),this._ambientColor=new gt(.6,.6,.6),this._specularColor=new gt(1,1,1),this._reflectColor=new gt(1,1,1)}r(e,"laya.d3.core.light.LightSprite",t);var i=e.prototype;return i._onRemoved=function(){this.scene._removeLight(this)},i._onAdded=function(){this.scene._addLight(this)},i.updateToWorldState=function(t){},a(0,i,"diffuseColor",function(){return this._diffuseColor},function(t){this._diffuseColor=t}),a(0,i,"lightType",function(){return-1}),a(0,i,"ambientColor",function(){return this._ambientColor},function(t){this._ambientColor=t}),a(0,i,"specularColor",function(){return this._specularColor},function(t){this._specularColor=t}),a(0,i,"reflectColor",function(){return this._reflectColor},function(t){this._reflectColor=t}),e.TYPE_DIRECTIONLIGHT=1,e.TYPE_POINTLIGHT=2,e.TYPE_SPOTLIGHT=3,e}(bt)),Ut=(function(t){function e(t){this.templet=null,e.__super.call(this),this.templet=new Lt(t)}r(e,"laya.d3.core.particle.Particle3D",t);var i=e.prototype;return i.addParticle=function(t,e){gt.add(this.transform.localPosition,t,t),this.templet.addParticle(t,e)},i._update=function(t){this.templet.update(t.elapsedTime),t.owner=this;var e=t.worldTransformModifyID;t.worldTransformModifyID+=this.transform._worldTransformModifyID,this.transform.getWorldMatrix(t.worldTransformModifyID);var i;0===this.templet.settings.blendState?i=t.scene.getRenderObject(7):1===this.templet.settings.blendState&&(i=t.scene.getRenderObject(9)),i.owner=t.owner=this,i.renderElement=this.templet,i.material=null,t.worldTransformModifyID=e,this._childs.length&&this._updateChilds(t)},e}(bt),function(t){function e(t,i){this._uint8Array=null,this._uint16Array=null,this._indexCount=0,void 0===i&&(i=35044),e.__super.call(this),this._indexCount=t,this._bufferUsage=i,this._type=34963,this._buffer=new ArrayBuffer(2*t)}r(e,"laya.d3.graphics.IndexBuffer3D",t);var i=e.prototype;return i._bufferData=function(){this._maxsize=Math.max(this._maxsize,this._length),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,o._gl.bufferData(this._type,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),o._gl.bufferSubData(this._type,0,this._buffer)},i._bufferSubData=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._maxsize=Math.max(this._maxsize,this._length),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,o._gl.bufferData(this._type,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),e||i){var n=this._buffer.slice(e,i);o._gl.bufferSubData(this._type,t,n)}else o._gl.bufferSubData(this._type,t,this._buffer)},i._checkArrayUse=function(){this._uint8Array&&(this._uint8Array=new Uint8Array(this._buffer)),this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer))},i.getUint8Array=function(){return this._uint8Array||(this._uint8Array=new Uint8Array(this._buffer))},i.getUint16Array=function(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer))},a(0,i,"indexCount",function(){return this._indexCount}),e.create=function(t,i){return void 0===i&&(i=35044),new e(t,i)},e}(o)),Ft=function(t){function e(t,i,n){this._floatArray32=null,this._vertexDeclaration=null,this._vertexCount=0,e.__super.call(this),this._vertexDeclaration=t,this._vertexCount=i,this._bufferUsage=n,this._type=34962,this._buffer=new ArrayBuffer(this._vertexDeclaration.vertexStride*i),this.getFloat32Array()}r(e,"laya.d3.graphics.VertexBuffer3D",t);var i=e.prototype;return i._bufferData=function(){this._maxsize=Math.max(this._maxsize,this._length),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,o._gl.bufferData(this._type,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),o._gl.bufferSubData(this._type,0,this._buffer)},i._bufferSubData=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._maxsize=Math.max(this._maxsize,this._length),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,o._gl.bufferData(this._type,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),e||i){var n=this._buffer.slice(e,i);o._gl.bufferSubData(this._type,t,n)}else o._gl.bufferSubData(this._type,t,this._buffer)},i.getFloat32Array=function(){return this._floatArray32||(this._floatArray32=new Float32Array(this._buffer))},i.bind=function(t){t&&t._bind(),this._bind()},i.insertData=function(t,e){var i=this.getFloat32Array();i.set(t,e),this._upload=!0},i.bind_upload=function(t){t._bind_upload()||t._bind(),this._bind_upload()||this._bind()},i._checkArrayUse=function(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer))},i.disposeCPUData=function(){t.prototype.disposeCPUData.call(this),this._floatArray32=null},i.detoryResource=function(){for(var e=this._vertexDeclaration.getVertexElements(),i=0;i<e.length;i++)w.mainContext.disableVertexAttribArray(i);t.prototype.detoryResource.call(this)},a(0,i,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,i,"vertexCount",function(){return this._vertexCount}),e.create=function(t,i,n){return void 0===n&&(n=35044),new e(t,i,n)},e}(o),Bt=function(t){function e(t){this._vb=null,this._saveToMergeRendering=!1,this._mergeRenderingList=null,this._useFullBone=!0,this._materialsMap=null,this._url=null,this._loaded=!1,e.__super.call(this),this._materials=new Array,this._subMeshes=[];var i=this,n=arguments;this._mergeRenderingList=[],this._mergeRenderingList._length=0;for(var r=0,a=n.length;a>r;r++)this.add(n[r]);this.on("loaded",this,function(t){i._loaded=!0})}r(e,"laya.d3.resource.tempelet.MeshTemplet",t);var i=e.prototype;return i.add=function(t){return this._subMeshes.push(t),this},i.regMaterials=function(t,e){this._materialsMap||(this._materialsMap={}),this._materialsMap[t]=e},i.cloneActiveMaterials=function(t){t||(t=[]),t.length=this._materials.length;for(var e=0,i=this._materials.length;i>e;e++)t[e]||(t[e]=new At),this._materials[e].copy(t[e]);return t},i.disableUseFullBone=function(){this._useFullBone=!1},i.getSubMesh=function(t){return this._subMeshes[t]},i.setShaderByName=function(t){this._materials&&this._materials.forEach(function(e){e.setShaderName(t)})},i.disableLight=function(){this._materials&&this._materials.forEach(function(t){t.disableLight()})},i.remove=function(t){var e=this._subMeshes.indexOf(t);return 0>e?!1:(this._subMeshes.splice(e,1),!0)},i.clear=function(){return this._subMeshes.length=0,this},i.dispose=function(){this._resourceManager.removeResource(this),laya.resource.Resource.prototype.dispose.call(this)},a(0,i,"loaded",function(){return this._loaded}),a(0,i,"subMeshes",function(){return this._subMeshes}),a(0,i,"materials",function(){return this._materials},function(t){this._materials=t}),a(0,i,"vb",function(){return this._vb},function(t){this._vb=t}),e}(Pt),Gt=(function(t){function e(){this._tempCurAnimationData=null,this._lastFrameIndex=-1,this._currentTransform=null,this._originalAnimationTransform=null,this._originalFov=0,this._camera=null,this._currentAnimationData=null,this.localMode=!0,this.addMode=!0,this._tempVector30=new gt,this._tempVector31=new gt,this._tempVector32=new gt,e.__super.call(this)}r(e,"laya.d3.component.animation.CameraAnimations",t);var i=e.prototype;return i._effect=function(){var t=0;for(t=0;3>t;t++)this._tempVector30.elements[t]=this._currentAnimationData[t],this._tempVector31.elements[t]=this._currentAnimationData[t+3],this._tempVector32.elements[t]=this._currentAnimationData[t+6];this._currentTransform||(this._currentTransform=new ft),ft.createLookAt(this._tempVector30,this._tempVector31,this._tempVector32,this._currentTransform),this._currentTransform.invert(this._currentTransform),this.addMode&&ft.multiply(this._originalAnimationTransform,this._currentTransform,this._currentTransform),this.localMode?this.owner.transform.localMatrix=this._currentTransform:this.owner.transform.worldMatrix=this._currentTransform,this._camera.fieldOfView=this._currentAnimationData[9]},i._load=function(t){var e=this;if(!(t instanceof laya.d3.core.camera.Camera))throw new Error("该Sprite3D并非Camera");this._camera=t,this.player.on("stopped",this,function(){e.player.returnToZeroStopped&&(e.localMode?e._originalAnimationTransform&&(t.transform.localMatrix=e._originalAnimationTransform):e._originalAnimationTransform&&(t.transform.worldMatrix=e._originalAnimationTransform),e._camera.fieldOfView=e._originalFov)})},i._update=function(t){if(this.player.update(t.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.State){var e=this.player.playbackRate*t.scene.timer.scale,i=this.player.isCache&&e>=1?this.currentFrameIndex:-1,n=this.currentAnimationClipIndex;if(-1!==i&&this._lastFrameIndex===i)return void laya.d3.component.Component3D.prototype._update.call(this,t);if(this.player.isCache&&e>=1){var r=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache,n,i);if(r)return this._currentAnimationData=r,this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,t),void this._effect()}var a=this._templet.getNodes(n),s=a.length;this.player.isCache&&e>=1?this._currentAnimationData=new Float32Array(10*s):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(10*s)),this._currentAnimationData=this._tempCurAnimationData),this.player.isCache&&e>=1?this._templet.getOriginalData(n,this._currentAnimationData,i,this.player.currentTime):this._templet.getOriginalDataUnfixedRate(n,this._currentAnimationData,this.player.currentTime),this.player.isCache&&e>=1&&this._templet.setAnimationDataWithCache(this._templet._animationDatasCache,n,i,this._currentAnimationData),this._lastFrameIndex=i,laya.d3.component.Component3D.prototype._update.call(this,t),this._effect()}},i.play=function(e,i,n){void 0===e&&(e=0),void 0===i&&(i=1),void 0===n&&(n=Number.MAX_VALUE),0===this.player.State&&(this._originalAnimationTransform||(this._originalAnimationTransform=new ft),this.localMode?this.owner.transform.localMatrix.cloneTo(this._originalAnimationTransform):this.owner.transform.worldMatrix.cloneTo(this._originalAnimationTransform)),this._originalFov=this._camera.fieldOfView,t.prototype.play.call(this,e,i,n)},e}(wt),function(t){function e(){this._tempCurBonesData=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._extenData=null,this._lastFrameIndex=-1,this._subMeshes=null,this._curBonesDatas=null,this._curAnimationDatas=null,e.__super.call(this)}r(e,"laya.d3.component.animation.SkinAnimations",t);var i=e.prototype;return i._load=function(t){var e=this;t.on("loaded",this,function(t){e._subMeshes=t.templet.subMeshes}),this.on("loaded",this,function(){e._templet._animationDatasCache[0]=[],e._templet._animationDatasCache[1]=[]}),this.player.on("stopped",this,function(){e._lastFrameIndex=-1,e.player.returnToZeroStopped&&(e._curBonesDatas=e._curAnimationDatas=null)})},i._update=function(t){if(this.player.update(t.elapsedTime),2===this.player.State&&this._templet&&this._templet.loaded){var e=this.player.playbackRate*t.scene.timer.scale,i=this.player.isCache&&e>=1,n=i?this.currentFrameIndex:-1;if(-1===n||this._lastFrameIndex!==n){var r=this.currentAnimationClipIndex;if(i){var a=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache[0],r,n);if(a)return this._curAnimationDatas=a,this._curBonesDatas=this._templet.getAnimationDataWithCache(this._templet._animationDatasCache[1],r,n),void(this._lastFrameIndex=n)}var s=this._templet.getNodes(r),o=s.length;i?(this._curAnimationDatas=new Float32Array(16*o),this._curBonesDatas=new Float32Array(16*o)):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(16*o)),this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(16*o)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(r))),i?this._templet.getOriginalData(r,this._curOriginalData,n,this.player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(r,this._curOriginalData,this.player.currentTime),this._extenData||(this._extenData=new Float32Array(this._templet.getPublicExtData())),Dt._computeSkinAnimationData(s,this._curOriginalData,this._extenData,this._curBonesDatas,this._curAnimationDatas),i&&(this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[0],r,n,this._curAnimationDatas),this._templet.setAnimationDataWithCache(this._templet._animationDatasCache[1],r,n,this._curBonesDatas)),this._lastFrameIndex=n}}},i._preRenderUpdate=function(t){if(this._curAnimationDatas){t.shaderDefs.addInt(512);var e=this._subMeshes[t.renderObj.renderElement.indexOfHost];Mt._copyBone(e._boneIndex,this._curAnimationDatas,e._boneData),t.shaderValue.pushValue("MATRIXARRAY0",e._boneData,-1)}},a(0,i,"curBonesDatas",function(){return this._curBonesDatas}),a(0,i,"curAnimationDatas",function(){return this._curAnimationDatas}),a(0,i,"url",t.prototype._$get_url,function(e){this._curOriginalData=this._extenData=null,t.prototype._$set_url.call(this,e)}),e}(wt)),Ht=(function(t){function e(){this._nodes=null,this._lasstInitIndex=-1,this._subMeshes=null,this._materials=null,this._mesh=null,this._meshDataInited=!1,this._uvDatasCount=0,this._subMeshIndexToNodeIndex=[],this._keyframeAges=[],this._ages=[],this._bufferUsages=[],this._originalShaderAttributes=[],this._uvShaderValues=[],this._uvNextShaderValues=[],this._uvAnimationBuffers=[],e.__super.call(this),this._meshDataInited=!1}r(e,"laya.d3.component.animation.UVAnimations",t);var i=e.prototype;return i._initMeshData=function(){this._materials=this._mesh.templet.materials,this._subMeshes=this._mesh.templet.subMeshes,this._meshDataInited=!0},i._initAnimationData=function(t){if(this._lasstInitIndex!==t){this._nodes=this._templet.getNodes(t);for(var e=0;e<this._nodes.length;e++){var i=this._nodes[e],n=i.extenData,r=new l(n),a=r.getInt32();this._uvDatasCount=r.getInt32();var s=this._subMeshes[a];if(this._subMeshIndexToNodeIndex[a]=e,!this._bufferUsages[e]){this._bufferUsages[e]={};for(var o in s._bufferUsage)this._bufferUsages[e][o]=s._bufferUsage[o]}this._originalShaderAttributes[e]=[];for(var h=0;h<this._uvDatasCount;h++)0===h?this._originalShaderAttributes[e][h]=s.getMaterial(s._meshTemplet.materials).getShaderAttribute("UV"):this._originalShaderAttributes[e][h]=s.getMaterial(s._meshTemplet.materials).getShaderAttribute("UV"+h.toString());var u=this._bufferUsages[e];for(this._uvAnimationBuffers[e]=new Array,h=0;h<this._uvDatasCount;h++){for(var _=i.keyframeWidth/this._uvDatasCount,c=new Float32Array(i.keyFrame.length*_),d=0,f=0;f<i.keyFrame.length;f++)c.set(i.keyFrame[f].data.subarray(h*_,(h+1)*_),d),d+=_;this._uvAnimationBuffers[e][h]=Ft.create(new laya.webgl.utils.VertexDeclaration(-1),35044),0===h?u.UV=u.NEXTUV=this._uvAnimationBuffers[e][h]:u["UV"+h.toString()]=u["NEXTUV"+h.toString()]=this._uvAnimationBuffers[e][h],this._uvAnimationBuffers[e][h].clear(),this._uvAnimationBuffers[e][h].append(c),this._uvAnimationBuffers[e][h].upload()}}this._lasstInitIndex=t}},i._load=function(t){var e=this;if(!(t instanceof laya.d3.core.fileModel.Mesh))throw new Error("该Sprite3D并非Mesh");this._mesh=t,t.on("loaded",this,function(t){!e._meshDataInited&&e._initMeshData(),2==e.player.State&&e._templet&&e._templet.loaded&&e._initAnimationData(e.currentAnimationClipIndex)}),this.on("loaded",this,function(){!e._meshDataInited&&e._initMeshData(),2==e.player.State&&e._mesh.templet&&e._mesh.templet.loaded&&e._initAnimationData(e.currentAnimationClipIndex)}),this.player.on("played",this,function(){e._templet&&e._templet.loaded&&e._mesh.templet&&e._mesh.templet.loaded&&e._initAnimationData(e.currentAnimationClipIndex)}),this.player.on("stopped",this,function(){if(e.player.returnToZeroStopped&&t instanceof laya.d3.core.fileModel.Mesh)for(var i=t.templet,n=i.materials,r=i.subMeshes,a=0;a<r.length;a++){var s=e._subMeshIndexToNodeIndex[a];if(null!=s)for(var o=0;o<e._uvDatasCount;o++)0===o?e._originalShaderAttributes[s]&&n[r[a].material].addOrUpdateShaderAttribute("UV",e._originalShaderAttributes[s][o],-1):e._originalShaderAttributes[s]&&n[r[a].material].addOrUpdateShaderAttribute("UV"+o.toString(),e._originalShaderAttributes[s][o],-1)}})},i._update=function(t){if(this.player.update(t.elapsedTime),this._templet&&this._templet.loaded&&2===this.player.State){for(var e=this.currentAnimationClipIndex,i=this._templet.getNodesCurrentFrameIndex(e,this.player.currentTime),n=0;n<this._nodes.length;n++){var r=i[n];this._keyframeAges[n]=(this.player.currentTime-this._nodes[n].keyFrame[r].startTime)/this._nodes[n].keyFrame[r].duration,this._ages[n]=this.player.currentTime/this._nodes[n].playTime;var a=this._nodes[n].keyframeWidth/this._uvDatasCount;this._uvShaderValues[n]||(this._uvShaderValues[n]=[]),this._uvNextShaderValues[n]||(this._uvNextShaderValues[n]=[]);for(var s=0;s<this._uvDatasCount;s++){var o=[2,5126,!1,0,r*a*4],l=[2,5126,!1,0,(r+1)*a*4];this._uvShaderValues[n][s]=o,this._uvNextShaderValues[n][s]=l}}laya.d3.component.Component3D.prototype._update.call(this,t)}},i._preRenderUpdate=function(t){if(this._templet&&this._templet.loaded&&2===this.player.State){var e=t.renderObj.renderElement.indexOfHost,i=this._subMeshes[e],n=this._subMeshIndexToNodeIndex[e];0!==this.player.State&&null!=n&&t.shaderDefs.addInt(65536);var r=i.getMaterial(this._materials);if(null!=n&&0!==this.player.State){t.shaderValue.pushValue("FLOAT0",this._keyframeAges[n],-1),t.shaderValue.pushValue("UVAGEX",this._ages[n],-1);for(var a=0;a<this._uvDatasCount;a++)0===a?(r.addOrUpdateShaderAttribute("UV",this._uvShaderValues[n][a],-1),r.addOrUpdateShaderAttribute("NEXTUV",this._uvNextShaderValues[n][a],-1)):(r.addOrUpdateShaderAttribute("UV"+a.toString(),this._uvShaderValues[n][a],-1),r.addOrUpdateShaderAttribute("NEXTUV"+a.toString(),this._uvNextShaderValues[n][a],-1));i._finalBufferUsageDic=this._bufferUsages[n]}}},e}(wt),function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.scene.Scene",t);var i=e.prototype;return i.renderSubmit=function(){var t=w.mainContext,e=this._renderState;this._set3DRenderConfig(t),this.currentCamera.clearColor&&this._clearColor(t),this._prepareScene(t,e),this.beforeUpate(e),this._updateScene(e),this.lateUpate(e),this.beforeRender(e);var i=this.currentCamera;return e.viewMatrix=i.viewMatrix,e.projectionMatrix=i.projectionMatrix,e.projectionViewMatrix=i.projectionViewMatrix,e.viewport=i.viewport,this._renderScene(t,e),this.lateRender(e),this._set2DRenderConfig(t),1},e}(St),function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.scene.VRScene",t);var i=e.prototype;return i.renderSubmit=function(){var t=w.mainContext,e=this._renderState;this._set3DRenderConfig(t),this.currentCamera.clearColor&&this._clearColor(t),this._prepareScene(t,e),e.shaderDefs.add(524288),this.beforeUpate(e),this._updateScene(e),this.lateUpate(e),this.beforeRender(e);var i=this.currentCamera;return e.viewMatrix=i.leftViewMatrix,e.projectionMatrix=i.leftProjectionMatrix,e.projectionViewMatrix=i.leftProjectionViewMatrix,e.viewport=i.leftViewport,this._renderScene(t,e),e.viewMatrix=i.rightViewMatrix,e.projectionMatrix=i.rightProjectionMatrix,e.projectionViewMatrix=i.rightProjectionViewMatrix,e.viewport=i.rightViewport,this._renderScene(t,e),this.lateRender(e),this._set2DRenderConfig(t),1},e}(St),function(t){function e(t,i,n,r,a){this._viewport=new xt(0,0,0,0),this._viewMatrix=new ft,this._projectionMatrix=new ft,this._projectionViewMatrix=new ft,void 0===i&&(i=Math.PI/3),void 0===n&&(n=0),void 0===r&&(r=.1),void 0===a&&(a=1e3),this._viewport=t,this._aspectRatio=n,e.__super.call(this,i,r,a)}r(e,"laya.d3.core.camera.Camera",t);var i=e.prototype;return i._calculateProjectionMatrix=function(){this._isOrthographicProjection||ft.createPerspective(this.fieldOfView,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix),this._projectionMatrixModifyID+=.01/this.id},a(0,i,"aspectRatio",function(){return 0===this._aspectRatio?this._viewport.width/this._viewport.height:this._aspectRatio},function(t){if(this.aspectRatio<0)throw new Error("横纵比必须是正值得Number！");this._aspectRatio=t,this._calculateProjectionMatrix()}),a(0,i,"viewport",function(){return this._viewport},function(t){this._viewport=t,this._calculateProjectionMatrix()}),a(0,i,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),a(0,i,"projectionMatrix",function(){return this._projectionMatrix}),a(0,i,"projectionViewMatrix",function(){return ft.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),e}(Rt),function(t){function e(t,i,n,r,a,s,o,l){this._tempMatrix=new ft,this._leftViewport=new xt(0,0,0,0),this._leftViewMatrix=new ft,this._leftProjectionMatrix=new ft,this._leftProjectionViewMatrix=new ft,this._rightViewport=new xt(0,0,0,0),this._rightViewMatrix=new ft,this._rightProjectionMatrix=new ft,this._rightProjectionViewMatrix=new ft,void 0===n&&(n=8),void 0===r&&(r=Math.PI/3),void 0===a&&(a=0),void 0===s&&(s=0),void 0===o&&(o=.1),void 0===l&&(l=1e3),this._leftViewport=t,this._rightViewport=i,this._pupilDistande=n,this._leftAspectRatio=a,this._rightAspectRatio=s,e.__super.call(this,r,o,l)}r(e,"laya.d3.core.camera.VRCamera",t);var i=e.prototype;return i._calculatePupilOffset=function(){var t=this._tempVector3;return gt.scale(this.right,this._pupilDistande/2,t),t.elements},i._calculateLeftProjectionMatrix=function(){this._isOrthographicProjection||(ft.createPerspective(this.fieldOfView,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),console.log(this.fieldOfView,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix)),this._projectionMatrixModifyID+=.01/this.id},i._calculateRightProjectionMatrix=function(){this._isOrthographicProjection||(ft.createPerspective(this.fieldOfView,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix),console.log(this.fieldOfView,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix)),this._projectionMatrixModifyID+=.01/this.id},i._calculateProjectionMatrix=function(){this._isOrthographicProjection||(ft.createPerspective(this.fieldOfView,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),ft.createPerspective(this.fieldOfView,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix)),this._projectionMatrixModifyID+=.01/this.id},a(0,i,"leftAspectRatio",function(){return 0===this._leftAspectRatio?this._leftViewport.width/this._leftViewport.height:this._leftAspectRatio},function(t){if(this.leftAspectRatio<0)throw new Error("横纵比必须是正值得Number！");this._leftAspectRatio=t,this._calculateLeftProjectionMatrix()}),a(0,i,"leftViewport",function(){return this._leftViewport},function(t){this._leftViewport=t,this._calculateLeftProjectionMatrix()}),a(0,i,"rightAspectRatio",function(){return 0===this._rightAspectRatio?this._rightViewport.width/this._rightViewport.height:this._rightAspectRatio},function(t){if(this.rightAspectRatio<0)throw new Error("横纵比必须是正值得Number！");this._rightAspectRatio=t,this._calculateRightProjectionMatrix()}),a(0,i,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,i,"leftProjectionViewMatrix",function(){
return ft.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),a(0,i,"rightViewport",function(){return this._rightViewport},function(t){this._rightViewport=t,this._calculateRightProjectionMatrix()}),a(0,i,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,i,"leftViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]-=t[0],i[13]-=t[1],i[14]-=t[2],e.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,i,"rightViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]+=t[0],i[13]+=t[1],i[14]+=t[2],e.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,i,"rightProjectionViewMatrix",function(){return ft.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),e}(Rt),function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.fileModel.SkyMesh",t);var i=e.prototype;return i._addToRenderQuene=function(t,e){return t.scene.getRenderObject(0)},i._praseSubMeshTemplet=function(t){return new yt(t)},e}(Ot));(function(t){function e(){this._direction=null,e.__super.call(this),this._diffuseColor=new gt(1,1,1),this._ambientColor=new gt(.6,.6,.6),this._specularColor=new gt(1,1,1),this._reflectColor=new gt(1,1,1),this._direction=new gt(0,-.5,-1)}r(e,"laya.d3.core.light.DirectionLight",t);var i=e.prototype;return i.updateToWorldState=function(t){if(t.scene.enableLight){var e=t.worldShaderValue,i=A.loopCount;t.shaderDefs.add(64),e.pushValue("LIGHTDIRDIFFUSE",this.diffuseColor.elements,i),e.pushValue("LIGHTDIRAMBIENT",this.ambientColor.elements,i),e.pushValue("LIGHTDIRSPECULAR",this.specularColor.elements,i),e.pushValue("LIGHTDIRECTION",this.direction.elements,i)}},a(0,i,"direction",function(){return this._direction},function(t){this._direction=t}),a(0,i,"lightType",function(){return 1}),e})(Nt),function(t){function e(){this._attenuation=null,this._range=NaN,e.__super.call(this),this._diffuseColor=new gt(1,1,1),this._ambientColor=new gt(.2,.2,.2),this._specularColor=new gt(1,0,0),this._reflectColor=new gt(1,1,1),this.transform.position=new gt(0,0,0),this._range=6,this._attenuation=new gt(.6,.6,.6)}r(e,"laya.d3.core.light.PointLight",t);var i=e.prototype;return i.updateToWorldState=function(t){if(t.scene.enableLight){var e=t.worldShaderValue,i=A.loopCount;t.shaderDefs.add(128),e.pushValue("POINTLIGHTDIFFUSE",this.diffuseColor.elements,i),e.pushValue("POINTLIGHTAMBIENT",this.ambientColor.elements,i),e.pushValue("POINTLIGHTSPECULAR",this.specularColor.elements,i),e.pushValue("POINTLIGHTPOS",this.transform.position.elements,i),e.pushValue("POINTLIGHTRANGE",this.range,i),e.pushValue("POINTLIGHTATTENUATION",this.attenuation.elements,i)}},a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t}),a(0,i,"lightType",function(){return 2}),e}(Nt),function(t){function e(){this._direction=null,this._attenuation=null,this._spot=NaN,this._range=NaN,e.__super.call(this),this._diffuseColor=new gt(1,1,1),this._ambientColor=new gt(.2,.2,.2),this._specularColor=new gt(1,1,1),this._reflectColor=new gt(1,1,1),this.transform.position=new gt(0,1,1),this._direction=new gt(0,-1,-1),this._attenuation=new gt(.6,.6,.6),this._spot=96,this._range=6}r(e,"laya.d3.core.light.SpotLight",t);var i=e.prototype;return i.updateToWorldState=function(t){if(t.scene.enableLight){var e=t.worldShaderValue,i=A.loopCount;t.shaderDefs.add(256),e.pushValue("SPOTLIGHTDIFFUSE",this.diffuseColor.elements,i),e.pushValue("SPOTLIGHTAMBIENT",this.ambientColor.elements,i),e.pushValue("SPOTLIGHTSPECULAR",this.specularColor.elements,i),e.pushValue("SPOTLIGHTPOS",this.transform.position.elements,i),e.pushValue("SPOTLIGHTDIRECTION",this.direction.elements,i),e.pushValue("SPOTLIGHTRANGE",this.range,i),e.pushValue("SPOTLIGHTSPOT",this.spot,i),e.pushValue("SPOTLIGHTATTENUATION",this.attenuation.elements,i)}},a(0,i,"direction",function(){return this._direction},function(t){this._direction=t}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t}),a(0,i,"spot",function(){return this._spot},function(t){this._spot=t}),a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"lightType",function(){return 3}),e}(Nt)}(window,document,Laya);